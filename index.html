<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-29XYBNJ2CB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-29XYBNJ2CB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind Finance - Gestion Intelligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'wikimind-bg': 'var(--bg)',
                        'wikimind-card': 'var(--card-bg)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg: #ffffff;
            --text: #111111;
            --card-bg: #f9fafb;
            --border: #e5e7eb;
            --accent: #000000;
            --accent-text: #ffffff;
        }

        .dark-mode {
            --bg: #0f0f0f;
            --text: #eeeeee;
            --card-bg: #161616;
            --border: #252525;
            --accent: #ffffff;
            --accent-text: #000000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        .glass-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        }
        .dark-mode .pulse-ai { animation: pulse-glow 3s infinite; box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        
        .bg-grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #555; }

        .transaction-item:hover { transform: translateX(5px); }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">
    <div class="bg-grain"></div>

    <!-- NAVBAR -->
    <header class="fixed top-0 w-full z-50 border-b border-gray-200/50 dark:border-gray-800/50 backdrop-blur-md transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 bg-black dark:bg-white text-white dark:text-black rounded-xl flex items-center justify-center font-black text-xl hover:rotate-12 transition-transform duration-300">W</div>
                <h1 class="text-xl font-black uppercase tracking-tighter italic">WikiMind <span class="text-gray-400 font-normal not-italic text-sm ml-2">Finance</span></h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="user-status" class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/20 text-[10px] font-bold uppercase text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Connect√©
                </div>
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-zinc-800 transition">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- LOADING SCREEN -->
    <div id="loader" class="fixed inset-0 z-[60] bg-white dark:bg-[#0f0f0f] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="animate-spin w-12 h-12 border-4 border-black dark:border-white border-t-transparent rounded-full mb-4"></div>
            <div class="text-xs font-bold uppercase tracking-widest animate-pulse">Chargement des finances...</div>
            <div class="text-[10px] text-gray-500 mt-2">Connexion √† la base s√©curis√©e</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <main class="flex-grow pt-32 pb-20 px-6 max-w-7xl mx-auto w-full z-10 grid grid-cols-1 lg:grid-cols-3 gap-8 relative">
        
        <!-- LEFT COLUMN: DASHBOARD & ACTIONS -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Balance Card -->
            <div class="glass-panel p-8 rounded-3xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-8 opacity-10 font-black text-9xl transform translate-x-10 -translate-y-10 group-hover:scale-110 transition duration-500">‚Ç¨</div>
                <div class="relative z-10">
                    <div class="text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">Solde Actuel</div>
                    <div id="total-balance" class="text-6xl md:text-7xl font-black tracking-tighter mb-4 text-transparent bg-clip-text bg-gradient-to-r from-black to-gray-500 dark:from-white dark:to-gray-500">
                        0.00 ‚Ç¨
                    </div>
                    <div class="flex gap-6 text-sm">
                        <div class="flex items-center gap-2 text-green-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            <span class="font-bold" id="total-income">+0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex items-center gap-2 text-red-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                            <span class="font-bold" id="total-expense">-0.00 ‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Add Income -->
                <button onclick="openModal('income')" class="group glass-panel p-6 rounded-2xl flex items-center justify-between hover:border-green-500/50 transition duration-300">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-xl">üí∞</div>
                        <div class="text-left">
                            <div class="font-bold">Encaissement</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-wider">Ajouter un revenu</div>
                        </div>
                    </div>
                    <div class="text-xl group-hover:translate-x-2 transition">+</div>
                </button>
                
                <!-- Add Expense -->
                <button onclick="openModal('expense')" class="group glass-panel p-6 rounded-2xl flex items-center justify-between hover:border-red-500/50 transition duration-300">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-xl">üí∏</div>
                        <div class="text-left">
                            <div class="font-bold">D√©pense</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-wider">Ajouter un achat</div>
                        </div>
                    </div>
                    <div class="text-xl group-hover:translate-x-2 transition">+</div>
                </button>
            </div>

            <!-- Transactions List -->
            <div class="glass-panel p-8 rounded-3xl min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold uppercase tracking-tight">Historique</h3>
                    <button onclick="clearHistory()" class="text-[10px] text-red-500 hover:underline uppercase font-bold">R√©initialiser</button>
                </div>
                <div id="transactions-list" class="space-y-3">
                    <!-- Transactions injected via JS -->
                    <div class="text-center text-gray-500 py-10 text-sm">Aucune transaction pour le moment.</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: AI ANALYST & ACTIVITIES -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- AI Card -->
            <div class="glass-panel p-6 rounded-3xl border-t-4 border-blue-500 pulse-ai relative">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center font-bold text-xs">AI</div>
                    <h3 class="font-bold uppercase text-sm tracking-wider">WikiMind Advisor</h3>
                </div>
                
                <div id="ai-response" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed min-h-[100px] mb-4">
                    L'IA analyse vos finances en temps r√©el... Ajoutez des transactions pour commencer l'analyse.
                </div>

                <button onclick="askAI()" id="btn-ask-ai" class="w-full py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold text-xs uppercase tracking-widest hover:opacity-90 transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span>Lancer une analyse</span>
                </button>
            </div>

            <!-- Activities Stats -->
            <div class="glass-panel p-6 rounded-3xl">
                <h3 class="font-bold uppercase text-sm tracking-wider mb-6">Activit√©s & Sources</h3>
                <div id="activities-list" class="space-y-4">
                    <!-- Activities injected here -->
                </div>
                <button onclick="openActivityModal()" class="mt-6 w-full py-2 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl text-xs font-bold uppercase text-gray-400 hover:text-black dark:hover:text-white hover:border-solid transition">
                    + Cr√©er une source
                </button>
            </div>

        </div>

    </main>

    <!-- MODAL ADD TRANSACTION -->
    <div id="transaction-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm items-center justify-center">
        <div class="bg-white dark:bg-[#161616] p-8 rounded-3xl w-full max-w-md m-4 border border-gray-200 dark:border-gray-800 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 modal-content">
            <h3 id="modal-title" class="text-2xl font-black mb-6">Nouvelle Transaction</h3>
            
            <form id="transaction-form" class="space-y-4">
                <input type="hidden" id="trans-type">
                
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Montant (‚Ç¨)</label>
                    <input type="number" id="trans-amount" step="0.01" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-xl font-bold text-lg focus:outline-none focus:border-black dark:focus:border-white transition" required>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Activit√© / Source</label>
                    <select id="trans-activity" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-xl text-sm focus:outline-none transition">
                        <option value="Autre">Autre</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Description</label>
                    <input type="text" id="trans-desc" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-xl text-sm focus:outline-none transition" placeholder="Ex: McDo, Vente Vinted...">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('transaction-modal')" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-800 font-bold text-xs uppercase">Annuler</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold text-xs uppercase hover:opacity-90">Valider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ADD ACTIVITY -->
    <div id="activity-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm items-center justify-center">
        <div class="bg-white dark:bg-[#161616] p-8 rounded-3xl w-full max-w-md m-4 border border-gray-200 dark:border-gray-800 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 modal-content">
            <h3 class="text-2xl font-black mb-6">Nouvelle Source</h3>
            <p class="text-sm text-gray-500 mb-4">D√©finissez une activit√© (Job, Freelance, Site Web...) pour suivre ce qu'elle vous rapporte pr√©cis√©ment.</p>
            
            <form id="activity-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Nom de l'activit√©</label>
                    <input type="text" id="act-name" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-xl font-bold focus:outline-none transition" placeholder="Ex: Vente 3D, Baby-sitting..." required>
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Emoji</label>
                    <input type="text" id="act-icon" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-xl text-center text-2xl focus:outline-none transition" placeholder="üé®" maxlength="2" required>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('activity-modal')" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-800 font-bold text-xs uppercase">Annuler</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold text-xs uppercase hover:opacity-90">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // CONFIG FIREBASE (Corrig√©e avec databaseURL)
        const firebaseConfig = {
            apiKey: "AIzaSyAsV27OD4bARFOSDlZN1MAARSv9q2WBkdo",
            authDomain: "wikimind-pro.firebaseapp.com",
            // Cette ligne est cruciale pour √©viter le chargement infini :
            databaseURL: "https://wikimind-pro-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wikimind-pro",
            storageBucket: "wikimind-pro.firebasestorage.app",
            messagingSenderId: "154490257518",
            appId: "1:154490257518:web:3276b1e64f2db9894be67f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // API MISTRAL
        const MISTRAL_API_KEY = "O2qQ4mSRs2cyQ2osownAGbGq9foyvPXR";

        let currentUser = null;
        let financialData = {
            transactions: {},
            activities: {}
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Utilisateur connect√© :", user.uid);
                currentUser = user;
                initFinanceListeners(user.uid);
            } else {
                console.log("Utilisateur non connect√©, redirection...");
                window.location.href = "user.html"; 
            }
        });

        function initFinanceListeners(uid) {
            console.log("Tentative de connexion DB...");
            const financeRef = ref(db, 'users/' + uid + '/finance');
            
            onValue(financeRef, (snapshot) => {
                console.log("Donn√©es re√ßues !");
                const data = snapshot.val() || {};
                financialData = {
                    transactions: data.transactions || {},
                    activities: data.activities || {}
                };
                renderApp();
                document.getElementById('loader').style.display = 'none';
            }, (error) => {
                console.error("Erreur Firebase:", error);
                alert("Erreur d'acc√®s aux donn√©es. V√©rifiez vos R√®gles Firebase.");
                document.getElementById('loader').style.display = 'none';
            });
        }

        // --- RENDERING ---
        function renderApp() {
            let balance = 0;
            let income = 0;
            let expense = 0;
            const activityStats = {}; 

            // Init activity stats
            Object.values(financialData.activities).forEach(act => {
                activityStats[act.name] = { total: 0, icon: act.icon };
            });
            if(!activityStats["Autre"]) activityStats["Autre"] = { total: 0, icon: "üè∑Ô∏è" };

            const transactionsArray = [];

            if (financialData.transactions) {
                Object.keys(financialData.transactions).forEach(key => {
                    const t = financialData.transactions[key];
                    t.id = key;
                    transactionsArray.push(t);
                    
                    const amount = parseFloat(t.amount);
                    if (t.type === 'income') {
                        balance += amount;
                        income += amount;
                        
                        if(activityStats[t.activity]) {
                            activityStats[t.activity].total += amount;
                        } else {
                            if(!activityStats["Autre"]) activityStats["Autre"] = { total: 0, icon: "üè∑Ô∏è" };
                            activityStats["Autre"].total += amount;
                        }
                    } else {
                        balance -= amount;
                        expense += amount;
                    }
                });
            }

            // Update UI Numbers
            document.getElementById('total-balance').innerText = balance.toFixed(2) + " ‚Ç¨";
            document.getElementById('total-income').innerText = "+" + income.toFixed(2) + " ‚Ç¨";
            document.getElementById('total-expense').innerText = "-" + expense.toFixed(2) + " ‚Ç¨";

            // Update Transactions List
            transactionsArray.sort((a, b) => new Date(b.date) - new Date(a.date));
            const listEl = document.getElementById('transactions-list');
            listEl.innerHTML = '';

            if(transactionsArray.length === 0) {
                 listEl.innerHTML = '<div class="text-center text-gray-500 py-10 text-sm">Aucune transaction. Commencez par ajouter des revenus ou d√©penses.</div>';
            } else {
                transactionsArray.forEach(t => {
                    const isIncome = t.type === 'income';
                    const colorClass = isIncome ? 'text-green-500' : 'text-red-500';
                    const sign = isIncome ? '+' : '-';
                    const icon = (activityStats[t.activity] && activityStats[t.activity].icon) ? activityStats[t.activity].icon : "üìÑ";
                    
                    const div = document.createElement('div');
                    div.className = "transaction-item flex items-center justify-between p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-zinc-800/50 transition duration-300 border-b border-gray-100 dark:border-gray-800 last:border-0";
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-zinc-800 flex items-center justify-center text-lg shadow-sm">${icon}</div>
                            <div>
                                <div class="font-bold text-sm">${t.description}</div>
                                <div class="text-[10px] text-gray-500 uppercase tracking-widest">${t.activity || 'Autre'} ‚Ä¢ ${new Date(t.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="font-mono font-bold ${colorClass}">${sign}${parseFloat(t.amount).toFixed(2)} ‚Ç¨</div>
                    `;
                    listEl.appendChild(div);
                });
            }

            // Update Activities List
            const actListEl = document.getElementById('activities-list');
            actListEl.innerHTML = '';
            
            const sortedActivities = Object.entries(activityStats)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total);

            sortedActivities.forEach(act => {
                if(act.name === 'Autre' && act.total === 0) return; 

                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-zinc-900 border border-gray-100 dark:border-gray-800";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-xl">${act.icon}</div>
                        <div class="text-xs font-bold uppercase">${act.name}</div>
                    </div>
                    <div class="text-xs font-mono font-bold text-green-600 dark:text-green-400">+${act.total.toFixed(2)} ‚Ç¨</div>
                `;
                actListEl.appendChild(div);
            });

            // Update Select Options
            const selectEl = document.getElementById('trans-activity');
            selectEl.innerHTML = '<option value="Autre">Autre</option>';
            Object.values(financialData.activities).forEach(act => {
                const opt = document.createElement('option');
                opt.value = act.name;
                opt.innerText = `${act.icon} ${act.name}`;
                selectEl.appendChild(opt);
            });
        }

        // --- ACTIONS ---

        window.openModal = (type) => {
            const modal = document.getElementById('transaction-modal');
            const title = document.getElementById('modal-title');
            const typeInput = document.getElementById('trans-type');
            
            typeInput.value = type;
            title.innerText = type === 'income' ? 'Nouveau Revenu üí∞' : 'Nouvelle D√©pense üí∏';
            
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
                modal.querySelector('.modal-content').style.opacity = '1';
            }, 10);
        };

        window.openActivityModal = () => {
             const modal = document.getElementById('activity-modal');
             modal.style.display = 'flex';
             setTimeout(() => {
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
                modal.querySelector('.modal-content').style.opacity = '1';
            }, 10);
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            modal.querySelector('.modal-content').style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        };

        window.clearHistory = async () => {
            if(confirm("Voulez-vous vraiment effacer tout l'historique ?")) {
                const transRef = ref(db, 'users/' + currentUser.uid + '/finance/transactions');
                await remove(transRef);
            }
        };

        // Form Submit: Transaction
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('trans-type').value;
            const amount = document.getElementById('trans-amount').value;
            const activity = document.getElementById('trans-activity').value;
            const desc = document.getElementById('trans-desc').value;

            if(!currentUser) return;

            const transRef = ref(db, 'users/' + currentUser.uid + '/finance/transactions');
            await push(transRef, {
                type: type,
                amount: parseFloat(amount),
                activity: activity,
                description: desc || (type === 'income' ? 'Revenu' : 'Achat'),
                date: new Date().toISOString()
            });

            closeModal('transaction-modal');
            e.target.reset();
        });

        // Form Submit: Activity
        document.getElementById('activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('act-name').value;
            const icon = document.getElementById('act-icon').value;

            if(!currentUser) return;

            const actRef = ref(db, 'users/' + currentUser.uid + '/finance/activities');
            await push(actRef, {
                name: name,
                icon: icon
            });

            closeModal('activity-modal');
            e.target.reset();
        });

        // --- MISTRAL AI INTEGRATION ---
        window.askAI = async () => {
            const btn = document.getElementById('btn-ask-ai');
            const responseDiv = document.getElementById('ai-response');
            
            const originalBtn = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin mr-2">‚è≥</span> Analyse en cours...`;
            btn.disabled = true;
            responseDiv.innerHTML = "WikiMind se connecte au r√©seau neural pour analyser vos donn√©es...";

            const simplifiedTransactions = Object.values(financialData.transactions || {}).slice(-15).map(t => ({
                t: t.type,
                a: t.amount,
                c: t.activity,
                d: t.description
            }));
            
            const prompt = `
            Tu es WikiMind Finance, une IA sarcastique mais tr√®s utile pour la gestion financi√®re.
            Voici les donn√©es de l'utilisateur (JSON simplifi√©) :
            Transactions (15 derni√®res) : ${JSON.stringify(simplifiedTransactions)}
            
            T√¢che : Analyse ces donn√©es.
            1. Donne un r√©sum√© rapide de la sant√© financi√®re.
            2. Identifie quelle activit√© rapporte le plus.
            3. Donne un conseil concret pour √©conomiser ou mieux gagner.
            4. Sois concis (max 3 phrases) et tutoie l'utilisateur. Utilise des emojis.
            `;

            try {
                const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "mistral-tiny",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    const aiText = data.choices[0].message.content;
                    responseDiv.innerHTML = aiText.replace(/\n/g, '<br>');
                } else {
                    responseDiv.innerText = "Erreur de connexion √† l'IA.";
                }

            } catch (error) {
                console.error("AI Error:", error);
                responseDiv.innerText = "Impossible de contacter le cerveau WikiMind. V√©rifiez votre connexion.";
            } finally {
                btn.innerHTML = originalBtn;
                btn.disabled = false;
            }
        };

        // Theme Handling
        window.toggleTheme = () => {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('wikimind_theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const path = document.querySelector('#theme-icon path');
            if(isDark) {
                path.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
            } else {
                path.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
            }
        }

        const savedTheme = localStorage.getItem('wikimind_theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-mode');
            updateThemeIcon(true);
        }
    </script>
</body>
</html>

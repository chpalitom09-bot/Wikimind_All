<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-29XYBNJ2CB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-29XYBNJ2CB');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bg: '#0f0f0f',
                        surface: '#18181b',
                        border: '#27272a',
                        primary: '#ffffff'
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #0f0f0f; color: #fff; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid #27272a; }
        
        /* Loader Animation */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Transitions */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .view-section.active { display: flex; opacity: 1; }
        
        /* Drag Zone */
        .drag-over { background-color: rgba(255,255,255,0.05); border-color: #fff; transform: scale(1.02); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- TOAST NOTIFICATION (Feedback utilisateur) -->
    <div id="toast" class="fixed top-6 right-6 z-50 transform translate-x-full transition-transform duration-300 bg-white text-black px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 font-bold max-w-sm">
        <i id="toast-icon" class="fa-solid fa-info-circle"></i>
        <p id="toast-message">Notification</p>
    </div>

    <!-- 1. VUE AUTHENTIFICATION -->
    <section id="auth-view" class="view-section active w-full h-screen flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-surface border border-border p-8 rounded-3xl shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-white text-black rounded-xl mx-auto flex items-center justify-center text-2xl font-black mb-4">W</div>
                <h1 class="text-2xl font-bold">WikiMind Cloud</h1>
                <p class="text-gray-500 text-sm mt-2">Stockage personnel sécurisé</p>
            </div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Email</label>
                    <input type="email" id="email" class="w-full mt-1 bg-[#0f0f0f] border border-border rounded-xl px-4 py-3 focus:border-white focus:outline-none transition-colors" placeholder="nom@exemple.com" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Mot de passe</label>
                    <input type="password" id="password" class="w-full mt-1 bg-[#0f0f0f] border border-border rounded-xl px-4 py-3 focus:border-white focus:outline-none transition-colors" placeholder="••••••••" required>
                </div>
                
                <p id="auth-error" class="text-red-500 text-xs font-medium hidden"></p>

                <button type="submit" id="submit-btn" class="w-full bg-white text-black font-bold uppercase tracking-widest text-xs py-4 rounded-xl hover:bg-gray-200 transition-all">
                    Se Connecter
                </button>
            </form>

            <div class="mt-6 text-center">
                <button id="toggle-mode" class="text-xs text-gray-500 hover:text-white underline">Pas de compte ? S'inscrire</button>
            </div>
        </div>
    </section>

    <!-- 2. VUE DASHBOARD -->
    <section id="dashboard-view" class="view-section w-full min-h-screen flex-col">
        <!-- Header -->
        <header class="fixed top-0 w-full z-40 glass">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white text-black rounded-lg flex items-center justify-center font-black">W</div>
                    <span class="font-bold hidden sm:block">Cloud</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-display" class="text-xs text-gray-400 font-mono hidden md:block"></span>
                    <button id="logout-btn" class="text-xs font-bold uppercase tracking-widest hover:text-gray-400 transition">Déconnexion</button>
                </div>
            </div>
        </header>

        <!-- Contenu -->
        <main class="flex-grow pt-24 px-6 max-w-7xl mx-auto w-full pb-20">
            
            <!-- Barre de Quota -->
            <div class="mb-10 bg-surface border border-border p-6 rounded-2xl">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="font-bold text-lg">Espace utilisé</h2>
                    <span id="quota-label" class="text-xs font-mono text-gray-400">Chargement...</span>
                </div>
                <div class="w-full h-3 bg-[#0f0f0f] rounded-full overflow-hidden">
                    <div id="quota-bar" class="h-full bg-white w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <!-- Zone d'Upload -->
            <div id="drop-area" class="border-2 border-dashed border-border rounded-3xl p-10 flex flex-col items-center justify-center cursor-pointer hover:bg-surface hover:border-gray-500 transition-all mb-10 group">
                <input type="file" id="file-input" class="hidden">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-500 mb-4 group-hover:text-white transition-colors"></i>
                <p class="font-bold">Cliquez ou glissez un fichier ici</p>
                <p class="text-xs text-gray-500 mt-1">Max 100 Mo par fichier</p>
                
                <!-- Progression Upload -->
                <div id="upload-status" class="hidden w-full max-w-xs mt-4">
                    <div class="flex justify-between text-xs mb-1">
                        <span>Envoi en cours...</span>
                        <span id="upload-pct">0%</span>
                    </div>
                    <div class="w-full h-1 bg-gray-700 rounded-full">
                        <div id="upload-progress" class="h-full bg-blue-500 w-0 transition-all"></div>
                    </div>
                </div>
            </div>

            <!-- Grille de fichiers -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">Vos Fichiers</h3>
                <button onclick="window.location.reload()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

            <div id="file-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Les fichiers s'afficheront ici -->
            </div>
            
            <div id="empty-msg" class="hidden text-center py-12 text-gray-600">
                <i class="fa-regular fa-folder-open text-3xl mb-3"></i>
                <p>Aucun fichier trouvé.</p>
            </div>

        </main>
    </section>

    <!-- LOGIQUE JAVASCRIPT -->
    <script type="module">
        // Import Firebase (Version Modulaire Standard)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll, deleteObject, getMetadata } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyANlBgeT5iQAUbVUa5CohN-nmTa86VcrRE",
            authDomain: "wikimind-cloud.firebaseapp.com",
            projectId: "wikimind-cloud",
            storageBucket: "wikimind-cloud.firebasestorage.app",
            messagingSenderId: "33492114916",
            appId: "1:33492114916:web:564018b131602b40c93bf1"
        };

        // Initialisation
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Variables Globales
        let currentUser = null;
        let isRegistering = false;
        const MAX_QUOTA = 100 * 1024 * 1024; // 100 Mo

        // --- DOM ELEMENTS ---
        const authView = document.getElementById('auth-view');
        const dashView = document.getElementById('dashboard-view');
        const authForm = document.getElementById('auth-form');
        const emailIn = document.getElementById('email');
        const passIn = document.getElementById('password');
        const submitBtn = document.getElementById('submit-btn');
        const authError = document.getElementById('auth-error');
        const toggleBtn = document.getElementById('toggle-mode');
        const fileGrid = document.getElementById('file-grid');
        const dropArea = document.getElementById('drop-area');

        // --- GESTION DE L'AUTHENTIFICATION ---
        
        // Surveiller l'état de connexion (Le Cœur du système)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Utilisateur connecté :", user.email);
                currentUser = user;
                document.getElementById('user-display').textContent = user.email;
                switchView('dashboard');
                loadFiles(); // Charger les fichiers une fois connecté
            } else {
                console.log("Utilisateur déconnecté");
                currentUser = null;
                switchView('auth');
            }
        });

        // Toggle Connexion / Inscription
        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isRegistering = !isRegistering;
            if(isRegistering) {
                document.querySelector('#auth-view h1').textContent = "Créer un compte";
                submitBtn.textContent = "S'INSCRIRE";
                toggleBtn.textContent = "Déjà un compte ? Se connecter";
            } else {
                document.querySelector('#auth-view h1').textContent = "WikiMind Cloud";
                submitBtn.textContent = "SE CONNECTER";
                toggleBtn.textContent = "Pas de compte ? S'inscrire";
            }
            authError.classList.add('hidden');
        });

        // Soumission du formulaire
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.classList.add('hidden');
            const email = emailIn.value;
            const pass = passIn.value;
            
            // UI Loading
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<div class="spinner"></div>';
            submitBtn.disabled = true;

            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    showToast('Compte créé avec succès !', 'success');
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    // Pas besoin de toast ici, onAuthStateChanged fera le travail
                }
            } catch (error) {
                console.error("Erreur Auth:", error);
                authError.textContent = getFriendlyErrorMessage(error.code);
                authError.classList.remove('hidden');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // --- GESTION DES FICHIERS ---

        async function loadFiles() {
            if (!currentUser) return;
            fileGrid.innerHTML = ''; // Clear
            document.getElementById('empty-msg').classList.add('hidden');
            let totalBytes = 0;

            const listRef = ref(storage, `users/${currentUser.uid}/files/`);

            try {
                const res = await listAll(listRef);
                
                if(res.items.length === 0) {
                    document.getElementById('empty-msg').classList.remove('hidden');
                    updateQuota(0);
                    return;
                }

                // Récupérer les métadonnées pour chaque fichier
                const filePromises = res.items.map(item => getMetadata(item));
                const filesData = await Promise.all(filePromises);

                // Trier par date (plus récent en premier)
                filesData.sort((a, b) => new Date(b.timeCreated) - new Date(a.timeCreated));

                filesData.forEach(meta => {
                    totalBytes += meta.size;
                    renderFileCard(meta);
                });

                updateQuota(totalBytes);

            } catch (error) {
                console.error("Erreur chargement:", error);
                showToast("Erreur de chargement des fichiers", "error");
            }
        }

        function renderFileCard(meta) {
            const card = document.createElement('div');
            card.className = "bg-surface border border-border rounded-xl p-4 flex flex-col justify-between h-40 hover:border-white transition-colors relative group animate-fade";
            
            const icon = getIcon(meta.contentType);
            const size = formatSize(meta.size);
            const path = meta.fullPath;

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="text-2xl text-gray-300">${icon}</div>
                    <button class="delete-btn text-gray-600 hover:text-red-500 transition p-1" data-path="${path}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div class="mt-auto">
                    <div class="font-bold text-sm truncate mb-1" title="${meta.name}">${meta.name}</div>
                    <div class="flex justify-between items-end">
                        <span class="text-[10px] text-gray-500">${size}</span>
                        <button class="download-btn bg-white text-black text-[10px] font-bold px-2 py-1 rounded hover:bg-gray-200" data-path="${path}">
                            <i class="fa-solid fa-download"></i>
                        </button>
                    </div>
                </div>
            `;

            // Events
            card.querySelector('.delete-btn').addEventListener('click', () => deleteFile(path));
            card.querySelector('.download-btn').addEventListener('click', () => downloadFile(path, meta.name));

            fileGrid.appendChild(card);
        }

        // --- ACTIONS UPLOAD / DELETE ---

        // Drag & Drop
        dropArea.addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e) => handleUpload(e.target.files[0]));
        
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('drag-over'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
        });

        function handleUpload(file) {
            if (!file || !currentUser) return;
            
            if (file.size > 100 * 1024 * 1024) { // 100MB Limit per file
                showToast("Fichier trop volumineux (>100Mo)", "error");
                return;
            }

            // Afficher UI
            const statusBox = document.getElementById('upload-status');
            const progressBar = document.getElementById('upload-progress');
            const pctText = document.getElementById('upload-pct');
            statusBox.classList.remove('hidden');

            const storageRef = ref(storage, `users/${currentUser.uid}/files/${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    pctText.textContent = Math.round(progress) + '%';
                },
                (error) => {
                    console.error(error);
                    showToast("Erreur lors de l'upload", "error");
                    statusBox.classList.add('hidden');
                },
                () => {
                    showToast("Fichier envoyé !", "success");
                    statusBox.classList.add('hidden');
                    loadFiles(); // Recharger la liste
                }
            );
        }

        async function deleteFile(path) {
            if (!confirm("Supprimer définitivement ce fichier ?")) return;
            const fileRef = ref(storage, path);
            try {
                await deleteObject(fileRef);
                showToast("Fichier supprimé", "success");
                loadFiles();
            } catch (error) {
                showToast("Erreur suppression", "error");
            }
        }

        async function downloadFile(path, filename) {
            const fileRef = ref(storage, path);
            try {
                const url = await getDownloadURL(fileRef);
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                showToast("Erreur téléchargement", "error");
            }
        }

        // --- UTILITAIRES ---
        
        function switchView(viewName) {
            if (viewName === 'dashboard') {
                authView.classList.remove('active');
                setTimeout(() => {
                    authView.style.display = 'none';
                    dashView.style.display = 'flex';
                    setTimeout(() => dashView.classList.add('active'), 50);
                }, 500);
            } else {
                dashView.classList.remove('active');
                setTimeout(() => {
                    dashView.style.display = 'none';
                    authView.style.display = 'flex';
                    setTimeout(() => authView.classList.add('active'), 50);
                }, 500);
            }
        }

        function updateQuota(bytes) {
            const pct = Math.min((bytes / MAX_QUOTA) * 100, 100);
            document.getElementById('quota-bar').style.width = pct + '%';
            document.getElementById('quota-label').textContent = `${formatSize(bytes)} / 100 Mo`;
            
            // Couleur rouge si > 90%
            if(pct > 90) document.getElementById('quota-bar').classList.add('bg-red-500');
            else document.getElementById('quota-bar').classList.remove('bg-red-500');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'Ko', 'Mo', 'Go'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getIcon(type) {
            if (!type) return '<i class="fa-solid fa-file"></i>';
            if (type.includes('image')) return '<i class="fa-solid fa-image text-purple-400"></i>';
            if (type.includes('pdf')) return '<i class="fa-solid fa-file-pdf text-red-500"></i>';
            if (type.includes('video')) return '<i class="fa-solid fa-film text-blue-400"></i>';
            return '<i class="fa-solid fa-file-alt"></i>';
        }

        function getFriendlyErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-credential': return "Email ou mot de passe incorrect.";
                case 'auth/user-not-found': return "Aucun compte trouvé avec cet email.";
                case 'auth/wrong-password': return "Mot de passe incorrect.";
                case 'auth/email-already-in-use': return "Cet email est déjà utilisé.";
                case 'auth/weak-password': return "Le mot de passe doit faire 6 caractères min.";
                default: return "Une erreur est survenue (" + code + ")";
            }
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            const icon = document.getElementById('toast-icon');
            
            icon.className = type === 'success' ? 'fa-solid fa-check-circle text-green-500' : 'fa-solid fa-circle-xmark text-red-500';
            
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

    </script>
</body>
</html>

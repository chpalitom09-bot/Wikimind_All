<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-29XYBNJ2CB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-29XYBNJ2CB');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind | Diaporama Creator Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
    
    <!-- Markdown & PDF Export -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --text: #111111;
            --card-bg: #f9fafb;
            --border: #e5e7eb;
            --accent: #000000;
            --accent-text: #ffffff;
        }

        .dark-mode {
            --bg: #0f0f0f;
            --text: #eeeeee;
            --card-bg: #161616;
            --border: #252525;
            --accent: #ffffff;
            --accent-text: #000000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Components --- */
        .glass-header {
            background: rgba(var(--bg), 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }

        .input-area {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            font-size: 0.9rem;
            color: var(--text);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-area:focus { outline: none; border-color: var(--text); box-shadow: 0 0 0 2px rgba(125, 125, 125, 0.1); }

        .btn-primary {
            background-color: var(--accent); color: var(--accent-text); border: 1px solid var(--accent);
            padding: 12px 24px; border-radius: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; font-size: 0.75rem; cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background-color: transparent; color: var(--text); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 12px; font-weight: 600; font-size: 0.75rem;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .btn-secondary:hover:not(:disabled) { background-color: var(--card-bg); border-color: var(--text); }

        /* --- TEMPLATES STYLES --- */
        /* Chaque template red√©finit les variables CSS du slide */
        
        .slide-container {
            aspect-ratio: 16/9;
            width: 100%;
            position: relative;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        /* Template: Modern (Default) */
        .tpl-modern {
            background: #ffffff; color: #111;
            display: grid; grid-template-columns: 1fr 1fr;
        }
        .tpl-modern .slide-img { height: 100%; width: 100%; object-fit: cover; }
        .tpl-modern .slide-text { padding: 3rem; display: flex; flex-direction: column; justify-content: center; }
        .dark-mode .tpl-modern { background: #1a1a1a; color: #fff; }

        /* Template: Corporate */
        .tpl-corporate {
            background: #f3f4f6; color: #1f2937;
            display: flex; flex-direction: column;
        }
        .tpl-corporate::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 10px; background: #2563eb; }
        .tpl-corporate .slide-text { padding: 3rem 4rem; z-index: 10; }
        .tpl-corporate .slide-img { position: absolute; bottom: 2rem; right: 2rem; width: 200px; height: 200px; border-radius: 12px; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .dark-mode .tpl-corporate { background: #111827; color: #f9fafb; }

        /* Template: Creative */
        .tpl-creative {
            background: #000; color: #fff;
        }
        .tpl-creative .slide-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .tpl-creative .slide-text { position: relative; z-index: 10; padding: 4rem; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .tpl-creative h1 { font-family: 'Playfair Display', serif; font-size: 3.5rem !important; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* Template: Cyber */
        .tpl-cyber {
            background: #09090b; color: #00ff9d;
            border: 2px solid #00ff9d;
            font-family: 'Montserrat', sans-serif;
            background-image: radial-gradient(#1a2e26 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .tpl-cyber .slide-text { padding: 3rem; }
        .tpl-cyber .slide-img { position: absolute; top: 3rem; right: 3rem; width: 300px; height: 100%; opacity: 0.8; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%); }
        .tpl-cyber h1 { text-transform: uppercase; letter-spacing: -2px; }

        /* Editable Areas */
        [contenteditable="true"] {
            border: 1px dashed transparent;
            transition: all 0.2s;
            cursor: text;
        }
        [contenteditable="true"]:hover {
            border-color: rgba(125, 125, 125, 0.3);
            background: rgba(125, 125, 125, 0.05);
            border-radius: 4px;
        }
        [contenteditable="true"]:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(125, 125, 125, 0.1);
        }

        /* Transitions */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .anim-fade .slide-text { animation: fadeIn 0.8s ease; }
        .anim-slide .slide-text { animation: slideInRight 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .anim-zoom .slide-container { animation: zoomIn 0.5s ease; }

        .loader {
            border: 2px solid var(--accent-text); border-top: 2px solid transparent; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .beta-badge {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white;
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 800;
            vertical-align: super; margin-left: 4px;
        }
    </style>
</head>
<body>

    <!-- SCRIPT FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getDatabase, ref, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsV27OD4bARFOSDlZN1MAARSv9q2WBkdo",
            authDomain: "wikimind-pro.firebaseapp.com",
            databaseURL: "https://wikimind-pro-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wikimind-pro",
            storageBucket: "wikimind-pro.firebasestorage.app",
            messagingSenderId: "154490257518",
            appId: "1:154490257518:web:3276b1e64f2db9894be67f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.firebaseDb = db;
        window.push = push;
        window.ref = ref;
        window.serverTimestamp = serverTimestamp;
        window.auth = auth;

        onAuthStateChanged(auth, (user) => {
            const btn = document.getElementById('auth-btn');
            const densitySelect = document.getElementById('density-select');
            const saveBtn = document.getElementById('save-btn');
            const saveTooltip = document.getElementById('save-tooltip');

            if (user) {
                window.currentUser = user;
                btn.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500"></div> <span>${user.displayName || 'Mon Espace'}</span>`;
                densitySelect.disabled = false;
                saveBtn.disabled = false;
                saveTooltip.style.display = 'none';
            } else {
                window.currentUser = null;
                btn.innerHTML = `<span>Mon Compte</span>`;
                densitySelect.value = "moderate";
                densitySelect.disabled = true;
                saveBtn.disabled = true;
                saveTooltip.style.display = 'block';
                saveTooltip.innerText = "Connectez-vous pour sauvegarder";
            }
        });
    </script>

    <!-- NAVBAR -->
    <header class="fixed top-0 w-full z-50 glass-header transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 bg-black dark:bg-white text-white dark:text-black rounded-xl flex items-center justify-center font-black text-xl hover:rotate-12 transition-transform duration-300">W</div>
                <div class="leading-none">
                    <h1 class="text-lg font-black uppercase tracking-tighter italic">WikiMind <span class="beta-badge">PRO</span></h1>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Diaporama Generator</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="index.html" class="hidden md:block text-xs font-bold uppercase tracking-widest hover:text-gray-500 transition">Retour Accueil</a>
                <a href="user.html" id="auth-btn" class="hidden md:flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-zinc-800 text-xs font-bold uppercase tracking-widest hover:bg-gray-200 dark:hover:bg-zinc-700 transition text-black dark:text-white"><span>Mon Compte</span></a>
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-zinc-800 transition text-black dark:text-white">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-28 pb-10 px-4 w-full max-w-7xl mx-auto h-full flex flex-col md:flex-row gap-8">
        
        <!-- SIDEBAR: CONFIGURATION -->
        <div class="w-full md:w-1/3 flex flex-col gap-6 h-fit sticky top-28 overflow-y-auto max-h-[85vh] pr-2">
            <div class="mb-2">
                <h2 class="text-2xl font-black tracking-tight mb-2">Studio Cr√©ation</h2>
                <p class="text-gray-500 text-xs leading-relaxed">G√©n√©rez, √©ditez et exportez des pr√©sentations intelligentes.</p>
            </div>

            <!-- Subject -->
            <div>
                <label class="block text-xs font-bold uppercase tracking-widest mb-2 text-gray-500">Sujet <span class="text-red-500">*</span></label>
                <input type="text" id="input-subject" class="input-area" placeholder="Ex: L'histoire de l'Empire Romain...">
            </div>

            <!-- Context -->
            <div>
                <label class="block text-xs font-bold uppercase tracking-widest mb-2 text-gray-500">Contexte / Source</label>
                <textarea id="input-context" class="input-area min-h-[80px]" placeholder="Optionnel: Collez un texte source..."></textarea>
            </div>

            <!-- Grid Settings -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Count -->
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest mb-2 text-gray-500">Slides: <span id="slide-val">5</span></label>
                    <input type="range" id="input-slides" min="3" max="15" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700" oninput="document.getElementById('slide-val').innerText = this.value">
                </div>
                <!-- Density -->
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest mb-2 text-gray-500">Densit√©</label>
                    <select id="density-select" class="input-area py-2 text-xs">
                        <option value="low">Faible</option>
                        <option value="moderate" selected>Mod√©r√©</option>
                        <option value="high">D√©taill√©</option>
                        <option value="auto">Auto IA</option>
                    </select>
                </div>
            </div>

            <!-- Template Selector -->
            <div>
                <label class="block text-xs font-bold uppercase tracking-widest mb-2 text-gray-500">Template</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setTemplate('modern')" class="h-10 rounded border border-gray-300 bg-white hover:border-black transition active-template ring-2 ring-offset-1 ring-black" title="Moderne"></button>
                    <button onclick="setTemplate('corporate')" class="h-10 rounded border border-gray-300 bg-gray-100 hover:border-blue-500 transition" title="Corporate"></button>
                    <button onclick="setTemplate('creative')" class="h-10 rounded border border-gray-300 bg-black hover:border-gray-500 transition" title="Cr√©atif"></button>
                    <button onclick="setTemplate('cyber')" class="h-10 rounded border border-gray-300 bg-zinc-900 border-green-500 hover:opacity-80 transition" title="Cyber"></button>
                </div>
            </div>

            <!-- Checkbox: No Watermark -->
            <div class="flex items-center gap-2">
                <input type="checkbox" id="no-watermark" onchange="toggleWatermark()" class="w-4 h-4 rounded border-gray-300 text-black focus:ring-black">
                <label for="no-watermark" class="text-xs font-bold text-gray-500 select-none cursor-pointer">Masquer "G√©n√©r√© par WikiMind"</label>
            </div>

            <!-- Generate -->
            <button id="generate-btn" onclick="generateSlides()" class="btn-primary w-full py-4 mt-2">
                <div class="loader" id="btn-loader"></div>
                <span id="btn-text">G√©n√©rer avec Mistral AI</span>
            </button>

             <!-- Export -->
             <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-800">
                <button onclick="exportPDF()" class="btn-secondary flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    PDF
                </button>
                <div class="relative group w-full">
                    <button id="save-btn" onclick="savePresentation()" disabled class="btn-secondary w-full flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Cloud
                    </button>
                    <div id="save-tooltip" class="absolute hidden group-hover:block bottom-full mb-2 right-0 w-32 p-2 bg-black text-white text-[10px] rounded text-center z-10">
                        Compte Requis
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN VIEW: PREVIEW -->
        <div class="w-full md:w-2/3 flex flex-col h-[calc(100vh-140px)]">
            
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Live Editor
                </h3>
                <button onclick="toggleFullscreen()" class="text-xs font-bold uppercase tracking-widest hover:text-gray-500 transition">Plein √âcran ‚õ∂</button>
            </div>

            <!-- Viewer -->
            <div id="preview-area" class="flex-grow flex flex-col gap-4 relative">
                
                <!-- Empty State -->
                <div id="empty-state" class="h-full border border-dashed border-gray-300 dark:border-zinc-800 rounded-2xl flex flex-col items-center justify-center text-gray-400 gap-4 bg-gray-50 dark:bg-zinc-900/50">
                    <div class="text-5xl opacity-20">üé®</div>
                    <p class="text-sm font-medium">Entrez un sujet et cliquez sur "G√©n√©rer"</p>
                </div>

                <!-- Slide Canvas (for Export) -->
                <div id="slide-viewer" class="hidden flex-col h-full justify-center">
                    
                    <div id="export-container" class="w-full">
                        <div id="current-slide" class="slide-container tpl-modern anim-slide shadow-2xl relative">
                            <!-- Injected Content -->
                            <img id="slide-img" class="slide-img" src="" alt="AI Generated">
                            <div class="slide-text">
                                <h1 id="slide-title" contenteditable="true" class="text-4xl font-black mb-4 leading-tight outline-none" onblur="updateData('title', this.innerText)">Titre</h1>
                                <div id="slide-body" contenteditable="true" class="text-lg leading-relaxed outline-none" onblur="updateData('content', this.innerHTML)">Contenu</div>
                            </div>

                            <div id="slide-footer" class="slide-footer">
                                <span id="footer-title">Projet Sans Titre</span>
                                <span id="footer-page">1 / 5</span>
                                <span id="footer-branding">G√©n√©r√© par WikiMind</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Controls -->
                    <div class="flex justify-between items-center mt-6 bg-white dark:bg-zinc-900 p-2 rounded-xl border border-gray-200 dark:border-zinc-800 shadow-sm w-full max-w-md mx-auto">
                        <button onclick="changeSlide(-1)" class="p-3 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-lg transition">‚Üê</button>
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold uppercase tracking-widest text-gray-400">Navigation</span>
                            <span class="font-bold font-mono">Slide <span id="current-index">1</span></span>
                        </div>
                        <button onclick="changeSlide(1)" class="p-3 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-lg transition">‚Üí</button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- LOGIC -->
    <script>
        const MISTRAL_API_KEY = "O2qQ4mSRs2cyQ2osownAGbGq9foyvPXR"; 
        const API_URL = "https://api.mistral.ai/v1/chat/completions";

        let generatedSlides = [];
        let currentSlideIndex = 0;
        let currentTemplate = 'modern';
        let showWatermark = true;
        let presentationTitle = "";

        // --- TEMPLATES ---
        function setTemplate(tpl) {
            currentTemplate = tpl;
            
            // UI Feedback
            document.querySelectorAll('.grid button').forEach(b => b.classList.remove('ring-2', 'ring-offset-1', 'ring-black'));
            event.currentTarget.classList.add('ring-2', 'ring-offset-1', 'ring-black');

            // Apply
            const container = document.getElementById('current-slide');
            container.className = `slide-container tpl-${tpl} anim-fade shadow-2xl relative`;
            
            // Re-render to adjust image/text layout if needed by CSS
            displaySlide(currentSlideIndex);
        }

        function toggleWatermark() {
            showWatermark = !document.getElementById('no-watermark').checked;
            const el = document.getElementById('footer-branding');
            if(el) el.style.opacity = showWatermark ? '0.5' : '0';
        }

        // --- GENERATION ---
        async function generateSlides() {
            const subject = document.getElementById('input-subject').value.trim();
            const count = document.getElementById('input-slides').value;
            const density = document.getElementById('density-select').value;
            const context = document.getElementById('input-context').value.trim();

            if (!subject) return alert("Sujet manquant !");

            const btn = document.getElementById('generate-btn');
            const loader = document.getElementById('btn-loader');
            const btnText = document.getElementById('btn-text');
            
            btn.disabled = true; loader.style.display = 'block'; btnText.innerText = "Cr√©ation en cours...";

            // Prompt am√©lior√© pour demander un mot-cl√© image en Anglais (pour Pollinations.ai)
            const systemPrompt = `Tu es un expert PowerPoint. G√©n√®re un JSON STRICT pour une pr√©sentation.
            Sujet: ${subject}. Slides: ${count}. Densit√©: ${density}.
            
            Structure attendue pour chaque slide :
            {
                "title": "Titre percutant",
                "content": "HTML simple (<ul>, <p>, <strong>)",
                "image_keyword": "Un seul mot-cl√© ou courte phrase descriptive EN ANGLAIS pour g√©n√©rer une image (ex: 'ancient rome', 'futuristic city', 'meeting room')"
            }
            R√©ponds UNIQUEMENT le JSON (Tableau d'objets).`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${MISTRAL_API_KEY}` },
                    body: JSON.stringify({
                        model: "mistral-large-latest",
                        messages: [{ role: "system", content: systemPrompt }],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                let contentRaw = data.choices[0].message.content;
                let parsed = JSON.parse(contentRaw);

                if (parsed.slides) parsed = parsed.slides;
                else if (!Array.isArray(parsed)) parsed = Object.values(parsed).find(v => Array.isArray(v));

                generatedSlides = parsed;
                presentationTitle = subject;
                currentSlideIndex = 0;

                // UI Switch
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('slide-viewer').style.display = 'flex';
                
                displaySlide(0);

            } catch (e) {
                alert("Erreur IA: " + e.message);
            } finally {
                btn.disabled = false; loader.style.display = 'none'; btnText.innerText = "G√©n√©rer avec Mistral AI";
            }
        }

        // --- DISPLAY & EDIT ---
        function displaySlide(index) {
            if (!generatedSlides.length) return;
            if (index < 0) index = 0;
            if (index >= generatedSlides.length) index = generatedSlides.length - 1;
            
            currentSlideIndex = index;
            const slide = generatedSlides[index];

            // Update DOM Elements
            document.getElementById('slide-title').innerText = slide.title;
            document.getElementById('slide-body').innerHTML = slide.content;
            
            // Image IA via Pollinations (Gratuit, Rapide, Pas de cl√©)
            const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(slide.image_keyword)}?width=800&height=600&nologo=true`;
            document.getElementById('slide-img').src = imgUrl;

            // Footer
            document.getElementById('footer-title').innerText = presentationTitle;
            document.getElementById('footer-page').innerText = `${index + 1} / ${generatedSlides.length}`;
            document.getElementById('current-index').innerText = index + 1;
            
            toggleWatermark(); // Apply preference

            // Trigger Animation
            const container = document.getElementById('current-slide');
            container.classList.remove('anim-slide');
            void container.offsetWidth; // Force reflow
            container.classList.add('anim-slide');
        }

        function changeSlide(dir) {
            displaySlide(currentSlideIndex + dir);
        }

        function updateData(field, val) {
            if(generatedSlides[currentSlideIndex]) {
                generatedSlides[currentSlideIndex][field] = val;
            }
        }

        // --- THEME SWITCHER ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('wikimind_theme', isDark ? 'dark' : 'light');
        }
        if(localStorage.getItem('wikimind_theme') === 'dark') document.body.classList.add('dark-mode');

        // --- FULLSCREEN ---
        function toggleFullscreen() {
            const el = document.getElementById('current-slide');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }

        // --- EXPORT PDF ---
        function exportPDF() {
            if(!generatedSlides.length) return alert("Rien √† exporter !");
            
            const element = document.getElementById('export-container');
            const opt = {
                margin: 0,
                filename: `WikiMind_${presentationTitle.replace(/\s/g,'_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, // CORS important pour les images externes
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            // Hack: Loop through slides and capture them one by one? 
            // For simple beta: Just print current view or create a long list hidden list.
            // Better approach for single page app: Print current slide.
            
            // Pour la d√©mo, on exporte la slide visible.
            // Pour exporter TOUT, il faudrait rendre toutes les slides dans un div cach√©.
            html2pdf().set(opt).from(element).save();
        }

        // --- FIREBASE SAVE ---
        async function savePresentation() {
            if (!window.currentUser) return;
            const btn = document.getElementById('save-btn');
            btn.innerHTML = "Sauvegarde...";
            try {
                const uid = window.currentUser.uid;
                await window.push(window.ref(window.firebaseDb, `users/${uid}/presentations`), {
                    title: presentationTitle,
                    slides: generatedSlides,
                    template: currentTemplate,
                    date: window.serverTimestamp()
                });
                alert("Sauvegard√© !");
            } catch(e) { console.error(e); alert("Erreur sauvegarde"); }
            btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg> Cloud`;
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind P4 - En Ligne</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { bg: '#050505', card: '#111111' }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; touch-action: manipulation; }
        
        .p4-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            padding: 8px;
            background: #1e1e24;
            border: 2px solid #333;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .cell {
            aspect-ratio: 1/1;
            background-color: #0a0a0a;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
        }
        
        .chip {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: absolute; top: 0; left: 0;
            animation: drop 0.4s ease-out forwards;
        }
        
        .chip.red { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); }
        .chip.yellow { background: radial-gradient(circle at 30% 30%, #eab308, #854d0e); }

        @keyframes drop { from { transform: translateY(-400%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .active-turn { box-shadow: 0 0 15px rgba(255,255,255,0.1); border-color: #555; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="h-14 border-b border-gray-800 bg-zinc-950 flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='Wikimind_games.html'">
            <div class="w-8 h-8 bg-white text-black rounded font-black flex items-center justify-center">W</div>
            <span class="font-bold hidden md:block">WikiMind P4</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full bg-red-500" id="conn-dot"></div>
            <span id="player-id" class="text-xs font-mono text-gray-400">Connexion...</span>
        </div>
    </header>

    <!-- Main Game Area -->
    <div class="flex-grow flex flex-col items-center justify-center p-4 relative">
        
        <!-- Info Bar -->
        <div class="w-full max-w-[400px] flex justify-between items-center mb-4 bg-zinc-900/50 p-2 rounded-lg border border-zinc-800">
            <div class="flex items-center gap-2" id="p1-display">
                <div class="w-6 h-6 rounded-full bg-red-500"></div>
                <div class="text-xs font-bold text-red-500">ROUGE (H√¥te)</div>
            </div>
            <div id="status-text" class="text-[10px] font-bold uppercase text-gray-500">En attente</div>
            <div class="flex items-center gap-2" id="p2-display">
                <div class="text-xs font-bold text-yellow-500">JAUNE (Invit√©)</div>
                <div class="w-6 h-6 rounded-full bg-yellow-500"></div>
            </div>
        </div>

        <!-- Board -->
        <div class="w-full max-w-[400px] aspect-[7/6]">
            <div id="game-board" class="p4-board w-full h-full"></div>
        </div>

        <!-- Controls / Menu Overlay if not playing -->
        <div id="menu-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center z-30 p-6">
            <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 w-full max-w-sm text-center">
                <h1 class="text-3xl font-black uppercase mb-6 italic">Puissance 4</h1>
                
                <!-- Online Tabs -->
                <div class="space-y-4">
                    <button id="btn-create" class="w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl uppercase tracking-widest transition">
                        Cr√©er une partie
                    </button>
                    
                    <div class="flex gap-2">
                        <input type="text" id="game-code-input" placeholder="Code de partie" class="flex-1 bg-black border border-zinc-700 rounded-xl px-4 text-center font-mono uppercase focus:border-white outline-none">
                        <button id="btn-join" class="px-6 bg-zinc-800 hover:bg-zinc-700 text-white font-bold rounded-xl uppercase tracking-widest transition">
                            Rejoindre
                        </button>
                    </div>

                    <div class="pt-4 border-t border-zinc-800">
                        <button onclick="startLocal()" class="text-xs text-gray-500 hover:text-white uppercase font-bold tracking-widest">
                            Jouer en Local (1vs1)
                        </button>
                    </div>
                </div>

                <!-- Waiting Screen -->
                <div id="waiting-screen" class="hidden mt-6">
                    <p class="text-xs text-gray-400 mb-2">Partagez ce code :</p>
                    <div id="code-display" class="text-3xl font-mono font-black text-white bg-black p-4 rounded-xl border border-red-500 select-all mb-2">...</div>
                    <p class="text-[10px] text-red-400 animate-pulse">En attente d'un adversaire...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div id="debug-log" class="fixed bottom-0 left-0 w-full h-12 bg-black border-t border-zinc-800 text-[10px] text-gray-500 font-mono p-2 overflow-y-auto z-50 opacity-50 pointer-events-none"></div>

    <!-- Modal Fin -->
    <div id="end-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-4" id="end-emoji">üèÜ</div>
            <h2 class="text-3xl font-black text-white mb-8" id="end-msg">VICTOIRE</h2>
            <button onclick="location.reload()" class="px-8 py-3 bg-white text-black font-bold rounded-full uppercase tracking-widest">Retour</button>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS STABLES (v10.8.0) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG (Votre config exacte)
        const firebaseConfig = {
            apiKey: "AIzaSyCy5oWMLf1hQmFgAqZDeNPJmfQj71u6Wio",
            authDomain: "wikimindchess.firebaseapp.com",
            databaseURL: "https://wikimindchess-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wikimindchess",
            storageBucket: "wikimindchess.firebasestorage.app",
            messagingSenderId: "78126540427",
            appId: "1:78126540427:web:a49673fd3148988e02d68e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- ETAT DU JEU ---
        const ROWS = 6, COLS = 7;
        let board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
        let myId = null;
        let gameId = null;
        let playerRole = 0; // 0=Spec, 1=Red(Host), 2=Yellow(Guest)
        let currentTurn = 1; 
        let isOnline = false;
        let gameActive = false;

        // --- AUTH ---
        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML = `> ${msg}<br>` + d.innerHTML;
        }

        signInAnonymously(auth).catch(e => log("Auth Error: " + e.message));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myId = user.uid;
                document.getElementById('conn-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('player-id').innerText = "ID: " + user.uid.substring(0,5);
                log("Connect√© Firebase.");
            }
        });

        // --- MOTEUR DE JEU ---
        function initGrid() {
            const bg = document.getElementById('game-board');
            bg.innerHTML = '';
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => handleClick(c);
                    bg.appendChild(cell);
                }
            }
        }

        function handleClick(col) {
            if(!gameActive) return;
            
            // R√®gle stricte en ligne : Est-ce mon tour ?
            if(isOnline) {
                if(playerRole !== currentTurn) {
                    log("Pas votre tour !");
                    return;
                }
            }

            // Calcul gravit√©
            let row = -1;
            for(let r=ROWS-1; r>=0; r--) {
                if(board[r][col] === 0) { row = r; break; }
            }
            if(row === -1) return; // Colonne pleine

            // Jouer le coup
            playMove(row, col, currentTurn);
        }

        function playMove(r, c, p) {
            // Mettre √† jour local
            board[r][c] = p;
            drawPiece(r, c, p);

            // V√©rifier victoire
            if(checkWin(r, c, p)) {
                endGame(p);
                if(isOnline) update(ref(db, `games_p4/${gameId}`), { board: JSON.stringify(board), winner: p });
                return;
            }

            // Passer le tour
            const next = p === 1 ? 2 : 1;
            currentTurn = next;
            updateStatus();

            // Si en ligne, envoyer √† Firebase
            if(isOnline) {
                update(ref(db, `games_p4/${gameId}`), {
                    board: JSON.stringify(board),
                    turn: next
                }).catch(e => log("Erreur Sync: " + e));
            }
        }

        function drawPiece(r, c, p) {
            const index = r * COLS + c;
            const container = document.getElementById('game-board').children[index];
            if(container.querySelector('.chip')) return; // D√©j√† dessin√©
            const chip = document.createElement('div');
            chip.className = `chip ${p === 1 ? 'red' : 'yellow'}`;
            container.appendChild(chip);
        }

        function updateStatus() {
            const txt = document.getElementById('status-text');
            const p1d = document.getElementById('p1-display');
            const p2d = document.getElementById('p2-display');

            p1d.style.opacity = currentTurn === 1 ? '1' : '0.3';
            p2d.style.opacity = currentTurn === 2 ? '1' : '0.3';

            if(isOnline) {
                if(currentTurn === playerRole) {
                    txt.innerText = "√Ä TOI DE JOUER !";
                    txt.className = "text-sm font-black text-green-500 animate-pulse";
                } else {
                    txt.innerText = "ADVERSAIRE R√âFL√âCHIT...";
                    txt.className = "text-[10px] font-bold text-gray-500";
                }
            } else {
                txt.innerText = currentTurn === 1 ? "TOUR ROUGE" : "TOUR JAUNE";
            }
        }

        // --- LOGIQUE EN LIGNE ---
        
        // 1. CR√âER
        document.getElementById('btn-create').addEventListener('click', () => {
            if(!myId) return alert("Attendez la connexion...");
            gameId = Math.random().toString(36).substring(2,6).toUpperCase();
            playerRole = 1; // H√¥te = Rouge
            isOnline = true;
            
            // Reset DB
            set(ref(db, `games_p4/${gameId}`), {
                host: myId,
                status: 'waiting',
                turn: 1,
                board: JSON.stringify(board)
            });

            // UI Waiting
            document.getElementById('btn-create').classList.add('hidden');
            document.getElementById('waiting-screen').classList.remove('hidden');
            document.getElementById('code-display').innerText = gameId;
            document.getElementById('game-code-input').parentElement.classList.add('hidden'); // Cacher input join

            listenGame();
        });

        // 2. REJOINDRE
        document.getElementById('btn-join').addEventListener('click', async () => {
            const code = document.getElementById('game-code-input').value.toUpperCase().trim();
            if(!code) return;
            
            const snap = await get(ref(db, `games_p4/${code}`));
            if(snap.exists() && snap.val().status === 'waiting') {
                gameId = code;
                playerRole = 2; // Invit√© = Jaune
                isOnline = true;

                // Update DB pour dire qu'on est l√†
                update(ref(db, `games_p4/${gameId}`), {
                    guest: myId,
                    status: 'playing'
                });

                document.getElementById('menu-overlay').classList.add('hidden');
                initGrid();
                gameActive = true;
                listenGame();
                log("Rejoint avec succ√®s !");
            } else {
                alert("Code invalide ou partie pleine.");
            }
        });

        // 3. ECOUTER (SYNC)
        function listenGame() {
            onValue(ref(db, `games_p4/${gameId}`), (snap) => {
                const data = snap.val();
                if(!data) return;

                // D√©marrage pour l'h√¥te
                if(data.status === 'playing' && playerRole === 1 && !gameActive) {
                    gameActive = true;
                    document.getElementById('menu-overlay').classList.add('hidden');
                    initGrid();
                    updateStatus();
                    log("Adversaire connect√© !");
                }

                // Sync Tour
                if(data.turn && data.turn !== currentTurn) {
                    currentTurn = data.turn;
                    updateStatus();
                }

                // Sync Plateau
                if(data.board) {
                    const remoteBoard = JSON.parse(data.board);
                    for(let r=0; r<ROWS; r++) {
                        for(let c=0; c<COLS; c++) {
                            // Si le serveur a une pi√®ce que je n'ai pas
                            if(board[r][c] === 0 && remoteBoard[r][c] !== 0) {
                                board[r][c] = remoteBoard[r][c];
                                drawPiece(r, c, remoteBoard[r][c]);
                            }
                        }
                    }
                }

                // Sync Victoire
                if(data.winner) {
                    endGame(data.winner);
                }
            });
        }

        // --- LOCAL ---
        window.startLocal = () => {
            isOnline = false;
            gameActive = true;
            document.getElementById('menu-overlay').classList.add('hidden');
            initGrid();
            updateStatus();
        };

        // --- VICTOIRE ---
        function checkWin(r, c, p) {
            const dirs = [[0,1], [1,0], [1,1], [1,-1]];
            for(let d of dirs) {
                let count = 1;
                for(let k=1; k<4; k++) {
                    const nr=r+d[0]*k, nc=c+d[1]*k;
                    if(nr<0||nr>=ROWS||nc<0||nc>=COLS||board[nr][nc]!==p) break;
                    count++;
                }
                for(let k=1; k<4; k++) {
                    const nr=r-d[0]*k, nc=c-d[1]*k;
                    if(nr<0||nr>=ROWS||nc<0||nc>=COLS||board[nr][nc]!==p) break;
                    count++;
                }
                if(count >= 4) return true;
            }
            return false;
        }

        function endGame(winner) {
            gameActive = false;
            document.getElementById('end-modal').classList.remove('hidden');
            const msg = winner === playerRole ? "TU AS GAGN√â !" : (isOnline ? "TU AS PERDU..." : "JOUEUR " + winner + " GAGNE");
            document.getElementById('end-msg').innerText = msg;
            document.getElementById('end-emoji').innerText = winner === playerRole ? "üéâ" : "üíÄ";
        }

        // Init blank grid visual
        initGrid();

    </script>
</body>
</html>

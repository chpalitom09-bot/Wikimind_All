<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind Guess - Version Stable</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LEAFLET (Carte) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PANNELLUM (Le moteur 360) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* CONTENEUR 360 */
        #panorama { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #000; }
        
        /* Message d'erreur si √©cran noir */
        #error-msg {
            display: none;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 5; text-align: center; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; border: 1px solid red;
        }

        /* HUD Overlay */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px 25px;
        }

        /* Timer Bar */
        #timer-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: rgba(255,255,255,0.1); z-index: 12;
        }
        #timer-bar {
            height: 100%; width: 100%; background: #ef4444;
            transition: width 1s linear;
        }

        /* Minimap */
        #guess-map-wrapper {
            position: absolute; bottom: 20px; right: 20px;
            width: 300px; height: 200px;
            z-index: 20;
            border-radius: 12px; overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            background: #1e293b;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #guess-map-wrapper:hover { width: 500px; height: 400px; }
        
        /* Mode R√©sultat */
        #guess-map-wrapper.result-mode {
            width: 80vw !important; height: 70vh !important;
            bottom: 50%; right: 50%;
            transform: translate(50%, 50%);
            border-color: #fbbf24;
            z-index: 100;
        }

        #guess-map { width: 100%; height: 100%; background: #111; cursor: crosshair; }

        /* Bouton Valider */
        #btn-guess {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1001; pointer-events: auto;
            background: #22c55e; color: white;
            font-weight: 800; padding: 12px 30px;
            border-radius: 9999px;
            border: 2px solid white;
            text-transform: uppercase; font-size: 14px; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        #btn-guess:hover { transform: translateX(-50%) scale(1.05); background: #16a34a; }
        #btn-guess:disabled { background: #525252; opacity: 0.5; cursor: not-allowed; }

        /* √âcrans */
        .fullscreen-overlay {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
        }
        .hidden { display: none !important; }

        .glass {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <!-- Message erreur si image bloque -->
    <div id="error-msg">
        <h3 class="text-red-500 font-bold text-xl">‚ö†Ô∏è Image bloqu√©e</h3>
        <p class="text-sm mt-2">Le navigateur a bloqu√© l'image 360¬∞.</p>
        <p class="text-xs text-gray-400 mt-1">Essaie d'installer l'extension "Web Server for Chrome"<br>ou lance ce fichier via un serveur local.</p>
    </div>

    <!-- HUD -->
    <div id="game-hud" class="hidden">
        <div id="timer-container"><div id="timer-bar"></div></div>
        
        <div class="hud-top">
            <div class="glass px-4 py-2 rounded-full bg-black/60 flex items-center gap-3">
                <span class="text-xs text-gray-400 uppercase font-bold">Round</span>
                <span id="round-display" class="text-xl font-black text-white">1/5</span>
            </div>
            <div class="glass px-4 py-2 rounded-full bg-black/60 text-right">
                <div class="text-xs text-gray-400 uppercase font-bold">Score</div>
                <div id="score-display" class="text-xl font-black text-yellow-400">0</div>
            </div>
        </div>
    </div>

    <!-- MENU -->
    <div id="menu-screen" class="fullscreen-overlay">
        <div class="glass max-w-lg w-full">
            <h1 class="text-5xl font-black mb-2 italic text-white">WIKI GUESS</h1>
            <p class="text-gray-400 mb-8 text-sm uppercase tracking-widest">Version Stable (Pannellum)</p>
            
            <button onclick="startGame()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-xl uppercase shadow-lg transition transform hover:scale-[1.02]">
                JOUER
            </button>
        </div>
    </div>

    <!-- JEU -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <!-- Le viewer 360 -->
        <div id="panorama"></div>

        <div id="guess-map-wrapper">
            <div id="guess-map"></div>
            <button id="btn-guess" onclick="submitGuess()">VALIDER</button>
        </div>
    </div>

    <!-- RESULTATS -->
    <div id="intermission-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-md w-full animate-bounce-in">
            <div class="text-5xl mb-4">üìç</div>
            <h2 class="text-3xl font-black text-white mb-2">R√âSULTAT</h2>
            <div class="py-6 border-y border-white/10 my-4">
                <div class="text-sm text-gray-400 uppercase">Distance</div>
                <div class="text-4xl font-mono font-bold text-white" id="round-distance">0 km</div>
                <div class="text-sm text-gray-400 uppercase mt-4">Points</div>
                <div class="text-5xl font-black text-green-400" id="round-score">+0</div>
            </div>
            <button onclick="nextRound()" class="w-full py-3 bg-white text-black font-bold rounded-lg uppercase hover:bg-gray-200 transition">Suite</button>
        </div>
    </div>

    <div id="end-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-lg w-full">
            <h2 class="text-4xl font-black text-white mb-2">SCORE FINAL</h2>
            <div class="text-7xl font-black text-yellow-400 mb-8" id="final-score">0</div>
            <button onclick="location.reload()" class="w-full py-4 bg-blue-600 font-bold rounded-xl uppercase">Rejouer</button>
        </div>
    </div>

    <script>
        // LISTE D'IMAGES FIABLES (H√©berg√©es sur Pannellum.org et Wikimedia avec CORS activ√©)
        const LOCATIONS = [
            { 
                name: "Alpes Suisses (Demo)", 
                lat: 46.558, lng: 7.905, 
                pano: "https://pannellum.org/images/alma.jpg" 
            },
            { 
                name: "Biblioth√®que de Londres", 
                lat: 51.507, lng: -0.127, 
                pano: "https://pannellum.org/images/bma-0.jpg" 
            },
            { 
                name: "Cerro Torre", 
                lat: -49.293, lng: -73.097, 
                pano: "https://pannellum.org/images/cerro-torre.jpg" 
            },
            { 
                name: "Grand Canyon (US)", 
                lat: 36.054, lng: -112.140, 
                pano: "https://upload.wikimedia.org/wikipedia/commons/2/21/Grand_Canyon_Horseshoe_Bend_Panorama.jpg" 
            },
            { 
                name: "Place Rouge (Moscou)", 
                lat: 55.753, lng: 37.622, 
                pano: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Red_Square_Saint_Basils_Cathedral_GUM_Mosaic_Panorama.jpg/1024px-Red_Square_Saint_Basils_Cathedral_GUM_Mosaic_Panorama.jpg" 
            }
        ];

        let map, viewer, guessMarker, targetMarker, linePoly;
        let currentRound = 0;
        let totalScore = 0;
        let timeLeft;
        let timerInterval;
        let currentLoc;
        const ROUND_TIME = 20;
        const MAX_ROUNDS = 5;
        let gameQueue = [];

        function startGame() {
            gameQueue = [...LOCATIONS].sort(() => 0.5 - Math.random()).slice(0, MAX_ROUNDS);
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            initMap();
            loadRound(0);
        }

        function initMap() {
            if(map) map.remove();
            map = L.map('guess-map', { zoomControl: false }).setView([20, 0], 1);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);
            map.on('click', (e) => {
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
            });
        }

        function loadRound(index) {
            currentRound = index;
            currentLoc = gameQueue[currentRound];
            
            // UI Reset
            document.getElementById('intermission-screen').classList.add('hidden');
            document.getElementById('guess-map-wrapper').classList.remove('result-mode');
            document.getElementById('btn-guess').disabled = false;
            document.getElementById('round-display').innerText = `${currentRound + 1}/${MAX_ROUNDS}`;
            document.getElementById('error-msg').style.display = 'none'; // Cacher erreur

            // Map Clean
            if(guessMarker) map.removeLayer(guessMarker);
            if(targetMarker) map.removeLayer(targetMarker);
            if(linePoly) map.removeLayer(linePoly);
            map.setView([20, 0], 1);
            map.invalidateSize();

            // CHARGEMENT PANNELLUM
            if(viewer) viewer.destroy();
            
            try {
                viewer = pannellum.viewer('panorama', {
                    type: 'equirectangular',
                    panorama: currentLoc.pano,
                    autoLoad: true,
                    showControls: false,
                    compass: false,
                    // Cette option aide parfois pour le CORS
                    crossOrigin: 'anonymous' 
                });
                
                // D√©tection d'erreur de chargement
                viewer.on('error', function(e) {
                    console.error("Erreur Pannellum:", e);
                    document.getElementById('error-msg').style.display = 'block';
                });
            } catch(e) {
                console.error(e);
                document.getElementById('error-msg').style.display = 'block';
            }

            startTimer();
        }

        function startTimer() {
            timeLeft = ROUND_TIME;
            const bar = document.getElementById('timer-bar');
            clearInterval(timerInterval);
            bar.style.transition = 'none';
            bar.style.width = '100%';
            setTimeout(() => {
                bar.style.transition = `width ${ROUND_TIME}s linear`;
                bar.style.width = '0%';
            }, 50);
            timerInterval = setInterval(() => {
                timeLeft--;
                if(timeLeft <= 0) submitGuess(true);
            }, 1000);
        }

        function submitGuess(force = false) {
            if (!guessMarker && !force) {
                alert("Clique sur la carte !");
                return;
            }
            clearInterval(timerInterval);
            document.getElementById('btn-guess').disabled = true;

            let dist = 10000; 
            let points = 0;
            let guessLatLng = null;

            if (guessMarker) {
                guessLatLng = guessMarker.getLatLng();
                dist = map.distance(guessLatLng, [currentLoc.lat, currentLoc.lng]) / 1000;
                points = Math.round(5000 * Math.exp(-dist / 2000));
            }
            
            totalScore += points;
            document.getElementById('score-display').innerText = totalScore;
            showMapResult(guessLatLng, [currentLoc.lat, currentLoc.lng]);
            setTimeout(() => { showIntermission(dist, points); }, 2500);
        }

        function showMapResult(guessPos, targetPos) {
            const wrapper = document.getElementById('guess-map-wrapper');
            wrapper.classList.add('result-mode');
            map.invalidateSize();

            targetMarker = L.marker(targetPos, {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/green-marker.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                })
            }).addTo(map);

            if (guessPos) {
                linePoly = L.polyline([guessPos, targetPos], {color: '#fbbf24', weight: 4, dashArray: '10, 10'}).addTo(map);
                map.fitBounds(linePoly.getBounds().pad(0.2));
            } else {
                map.setView(targetPos, 5);
            }
        }

        function showIntermission(dist, points) {
            document.getElementById('intermission-screen').classList.remove('hidden');
            document.getElementById('round-distance').innerText = dist > 9000 ? "Temps √âcoul√©" : Math.round(dist) + " km";
            document.getElementById('round-score').innerText = "+" + points;
        }

        window.nextRound = () => {
            if (currentRound + 1 < MAX_ROUNDS) {
                loadRound(currentRound + 1);
            } else {
                document.getElementById('intermission-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = totalScore;
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind Guess - Mapillary Edition</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LEAFLET (Carte) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* Conteneur de la vue Street View (Mapillary) */
        #street-view-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: #000;
        }
        #mly-frame {
            width: 100%; height: 100%; border: none;
            filter: contrast(1.1) saturate(1.1); /* Petit boost visuel */
        }

        /* HUD Overlay */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px 25px;
        }

        /* Timer Bar */
        #timer-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: rgba(255,255,255,0.1); z-index: 12;
        }
        #timer-bar {
            height: 100%; width: 100%; background: #0ea5e9;
            transition: width 1s linear;
            box-shadow: 0 0 10px #0ea5e9;
        }

        /* Carte de Guess */
        #guess-map-wrapper {
            position: absolute; bottom: 20px; right: 20px;
            width: 300px; height: 200px;
            z-index: 20;
            border-radius: 12px; overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            background: #1e293b;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #guess-map-wrapper:hover { width: 500px; height: 400px; }
        
        /* Mode Resultat (Carte en grand) */
        #guess-map-wrapper.result-mode {
            width: 80vw !important; height: 70vh !important;
            bottom: 50%; right: 50%;
            transform: translate(50%, 50%);
            border-color: #fbbf24;
            z-index: 100;
        }

        #guess-map { width: 100%; height: 100%; background: #111; cursor: crosshair; }

        /* Bouton Valider */
        #btn-guess {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1001; pointer-events: auto;
            background: #22c55e; color: white;
            font-weight: 800; padding: 12px 30px;
            border-radius: 9999px;
            border: 2px solid white;
            text-transform: uppercase; font-size: 14px; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        #btn-guess:hover { transform: translateX(-50%) scale(1.05); background: #16a34a; }
        #btn-guess:disabled { background: #525252; opacity: 0.5; cursor: not-allowed; }

        /* √âcrans (Menu, etc) */
        .fullscreen-overlay {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
        }
        .hidden { display: none !important; }

        .glass {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        /* Loader mapillary */
        #loading-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 0; color: gray; font-size: 12px; pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- HUD DU JEU -->
    <div id="game-hud" class="hidden">
        <div id="timer-container"><div id="timer-bar"></div></div>
        
        <div class="hud-top">
            <div class="glass px-4 py-2 rounded-full bg-black/60 flex items-center gap-3">
                <span class="text-xs text-gray-400 uppercase font-bold">Round</span>
                <span id="round-display" class="text-xl font-black text-white">1/5</span>
            </div>
            <div class="glass px-4 py-2 rounded-full bg-black/60 text-right">
                <div class="text-xs text-gray-400 uppercase font-bold">Score</div>
                <div id="score-display" class="text-xl font-black text-yellow-400">0</div>
            </div>
        </div>
    </div>

    <!-- MENU PRINCIPAL -->
    <div id="menu-screen" class="fullscreen-overlay">
        <div class="glass max-w-lg w-full relative overflow-hidden">
            <!-- D√©coration fond -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>

            <h1 class="text-5xl font-black mb-2 italic text-white tracking-tighter">STREET<span class="text-blue-500">GUESS</span></h1>
            <p class="text-gray-400 mb-8 text-sm uppercase tracking-widest">Mapillary Powered</p>
            
            <div class="grid grid-cols-2 gap-3 mb-8 text-left">
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <div class="text-blue-400 font-bold text-lg">üåç D√©placement</div>
                    <div class="text-xs text-gray-400">Tu peux bouger dans la rue</div>
                </div>
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <div class="text-green-400 font-bold text-lg">‚è±Ô∏è 30 Secondes</div>
                    <div class="text-xs text-gray-400">Pour trouver l'endroit</div>
                </div>
            </div>

            <button onclick="startGame()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-xl uppercase shadow-lg transition transform hover:scale-[1.02]">
                Lancer la partie
            </button>
        </div>
    </div>

    <!-- INTERFACE JEU -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <div id="street-view-container">
            <span id="loading-msg">Chargement Street View...</span>
            <iframe id="mly-frame" src="" allowfullscreen></iframe>
        </div>

        <div id="guess-map-wrapper">
            <div id="guess-map"></div>
            <button id="btn-guess" onclick="submitGuess()">VALIDER</button>
        </div>
    </div>

    <!-- √âCRAN R√âSULTAT INTERM√âDIAIRE -->
    <div id="intermission-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-md w-full animate-bounce-in">
            <div class="text-5xl mb-4">üéØ</div>
            <h2 class="text-3xl font-black text-white mb-2">R√âSULTAT</h2>
            
            <div class="py-6 border-y border-white/10 my-4">
                <div class="text-sm text-gray-400 uppercase">Distance</div>
                <div class="text-4xl font-mono font-bold text-white" id="round-distance">0 km</div>
                <div class="text-sm text-gray-400 uppercase mt-4">Points</div>
                <div class="text-5xl font-black text-green-400" id="round-score">+0</div>
            </div>

            <button onclick="nextRound()" class="w-full py-3 bg-white text-black font-bold rounded-lg uppercase hover:bg-gray-200 transition">
                Tour Suivant
            </button>
        </div>
    </div>

    <!-- √âCRAN FIN -->
    <div id="end-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-lg w-full text-center">
            <h2 class="text-4xl font-black text-white mb-2">FIN DE PARTIE</h2>
            <p class="text-gray-400 mb-6">Tous les lieux ont √©t√© visit√©s</p>
            
            <div class="text-7xl font-black text-yellow-400 mb-8" id="final-score">0</div>
            
            <button onclick="location.reload()" class="w-full py-4 bg-blue-600 font-bold rounded-xl uppercase">Rejouer</button>
        </div>
    </div>

    <script>
        // --- DATA (Mapillary Image Keys) ---
        // Ce sont des IDs d'images Mapillary v√©rifi√©s.
        // Avantage : Ce sont des iframes, donc 0 bug de texture ou de CORS.
        const LOCATIONS = [
            { key: "498763468214164", lat: 48.858, lng: 2.294, name: "Paris - Tour Eiffel" },
            { key: "313498964344462", lat: 40.758, lng: -73.985, name: "NY - Times Square" },
            { key: "1486331908422201", lat: 35.659, lng: 139.700, name: "Tokyo - Shibuya" },
            { key: "244678854228746", lat: 51.500, lng: -0.124, name: "Londres - Big Ben" },
            { key: "235658634734687", lat: -33.857, lng: 151.215, name: "Sydney - Opera" },
            { key: "508496494056285", lat: 41.890, lng: 12.492, name: "Rome - Colis√©e" },
            { key: "789642921822822", lat: 27.175, lng: 78.042, name: "Inde - Taj Mahal" },
            { key: "447844623788734", lat: 37.820, lng: -122.478, name: "San Francisco - Golden Gate" },
            { key: "515796696417531", lat: 55.752, lng: 37.622, name: "Moscou - Place Rouge" },
            { key: "123616616377014", lat: -22.951, lng: -43.210, name: "Rio - Christ R√©dempteur" }
        ];

        let map, guessMarker, targetMarker, linePoly;
        let currentRound = 0;
        let totalScore = 0;
        let timeLeft;
        let timerInterval;
        let currentLoc;
        const ROUND_TIME = 30; // Temps pour deviner
        const MAX_ROUNDS = 5;  // Nombre de manches par partie
        let gameQueue = [];

        function startGame() {
            // M√©langer et prendre 5 lieux au hasard
            gameQueue = [...LOCATIONS].sort(() => 0.5 - Math.random()).slice(0, MAX_ROUNDS);
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            initMap();
            loadRound(0);
        }

        function initMap() {
            if(map) map.remove();
            map = L.map('guess-map', { zoomControl: false }).setView([20, 0], 1);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            map.on('click', (e) => {
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
            });
        }

        function loadRound(index) {
            currentRound = index;
            currentLoc = gameQueue[currentRound];
            
            // Reset UI
            document.getElementById('intermission-screen').classList.add('hidden');
            document.getElementById('guess-map-wrapper').classList.remove('result-mode');
            document.getElementById('btn-guess').disabled = false;
            document.getElementById('round-display').innerText = `${currentRound + 1}/${MAX_ROUNDS}`;
            
            // Clean Map
            if(guessMarker) map.removeLayer(guessMarker);
            if(targetMarker) map.removeLayer(targetMarker);
            if(linePoly) map.removeLayer(linePoly);
            map.setView([20, 0], 1);
            map.invalidateSize();

            // Load Mapillary Iframe
            // On utilise l'embed officiel qui est stable
            const embedUrl = `https://www.mapillary.com/embed?image_key=${currentLoc.key}&style=classic`;
            document.getElementById('mly-frame').src = embedUrl;

            // Timer
            startTimer();
        }

        function startTimer() {
            timeLeft = ROUND_TIME;
            const bar = document.getElementById('timer-bar');
            
            clearInterval(timerInterval);
            bar.style.transition = 'none';
            bar.style.width = '100%';
            
            setTimeout(() => {
                bar.style.transition = `width ${ROUND_TIME}s linear`;
                bar.style.width = '0%';
            }, 50);

            timerInterval = setInterval(() => {
                timeLeft--;
                if(timeLeft <= 0) {
                    submitGuess(true);
                }
            }, 1000);
        }

        function submitGuess(force = false) {
            if (!guessMarker && !force) {
                alert("Place un point sur la carte !");
                return;
            }
            
            clearInterval(timerInterval);
            document.getElementById('btn-guess').disabled = true;

            let dist = 10000; // Penalit√© si pas de guess
            let points = 0;
            let guessLatLng = null;

            if (guessMarker) {
                guessLatLng = guessMarker.getLatLng();
                dist = map.distance(guessLatLng, [currentLoc.lat, currentLoc.lng]) / 1000;
                
                // Formule de score (max 5000)
                points = Math.round(5000 * Math.exp(-dist / 2000));
            }
            
            totalScore += points;
            document.getElementById('score-display').innerText = totalScore;

            showMapResult(guessLatLng, [currentLoc.lat, currentLoc.lng]);

            setTimeout(() => {
                showIntermission(dist, points);
            }, 2500);
        }

        function showMapResult(guessPos, targetPos) {
            const wrapper = document.getElementById('guess-map-wrapper');
            wrapper.classList.add('result-mode');
            map.invalidateSize();

            targetMarker = L.marker(targetPos, {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/green-marker.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                })
            }).addTo(map);

            if (guessPos) {
                linePoly = L.polyline([guessPos, targetPos], {color: '#fbbf24', weight: 4, dashArray: '10, 10'}).addTo(map);
                map.fitBounds(linePoly.getBounds().pad(0.2));
            } else {
                map.setView(targetPos, 5);
            }
        }

        function showIntermission(dist, points) {
            document.getElementById('intermission-screen').classList.remove('hidden');
            document.getElementById('round-distance').innerText = dist > 9000 ? "Temps √âcoul√©" : Math.round(dist) + " km";
            document.getElementById('round-score').innerText = "+" + points;
        }

        window.nextRound = () => {
            if (currentRound + 1 < MAX_ROUNDS) {
                loadRound(currentRound + 1);
            } else {
                document.getElementById('intermission-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = totalScore;
            }
        };

    </script>
</body>
</html>

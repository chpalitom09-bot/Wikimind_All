<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind Guess - Mode Arcade</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LEAFLET (Carte OpenSource Gratuite) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PANNELLUM (Lecteur 360 gratuit) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* Vue 360 */
        #panorama { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .pnlm-load-box { display: none !important; }
        .pnlm-about-msg { display: none !important; }

        /* HUD Overlay */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px 25px;
        }

        /* Timer Bar */
        #timer-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: rgba(255,255,255,0.2); z-index: 12;
        }
        #timer-bar {
            height: 100%; width: 100%; background: #ef4444;
            transition: width 1s linear;
        }

        /* Minimap Flottante */
        #guess-map-wrapper {
            position: absolute; bottom: 20px; right: 20px;
            width: 320px; height: 240px;
            z-index: 20;
            border-radius: 12px; overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            background: #1e293b;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0.9;
        }
        #guess-map-wrapper:hover { opacity: 1; width: 600px; height: 450px; }
        
        /* Mode Resultat Map (Plein √©cran partiel) */
        #guess-map-wrapper.result-mode {
            width: 80vw !important; height: 70vh !important;
            bottom: 50%; right: 50%;
            transform: translate(50%, 50%);
            border-color: #fbbf24;
        }

        #guess-map { width: 100%; height: 100%; background: #111; cursor: crosshair; }

        /* Bouton Guess */
        #btn-guess {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1001; pointer-events: auto;
            background: #22c55e; color: white;
            font-weight: 800; padding: 12px 40px;
            border-radius: 9999px;
            border: 2px solid white;
            text-transform: uppercase; font-size: 16px; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        #btn-guess:hover { transform: translateX(-50%) scale(1.05); background: #16a34a; }
        #btn-guess:disabled { background: #525252; cursor: not-allowed; opacity: 0; pointer-events: none; }

        /* √âcrans (Menu, Intermission, Fin) */
        .fullscreen-overlay {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* Glass Panel */
        .glass {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <!-- TIMER -->
    <div id="game-hud" class="hidden">
        <div id="timer-container"><div id="timer-bar"></div></div>
        
        <div class="hud-top">
            <div class="glass px-4 py-2 rounded-full bg-black/50 flex items-center gap-3">
                <span class="text-xs text-gray-400 uppercase font-bold">Manche</span>
                <span id="round-display" class="text-xl font-black text-white">1/10</span>
            </div>
            <div class="glass px-4 py-2 rounded-full bg-black/50 text-right">
                <div class="text-xs text-gray-400 uppercase font-bold">Score Total</div>
                <div id="score-display" class="text-xl font-black text-yellow-400">0 pts</div>
            </div>
        </div>
    </div>

    <!-- MENU PRINCIPAL -->
    <div id="menu-screen" class="fullscreen-overlay">
        <div class="glass max-w-lg w-full">
            <h1 class="text-6xl font-black mb-2 italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">WIKI GUESS</h1>
            <p class="text-gray-400 mb-8 tracking-widest uppercase text-xs">Edition Arcade Gratuite</p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4 text-left text-sm text-gray-300 mb-6">
                    <div class="bg-white/5 p-3 rounded">‚è±Ô∏è <b>20 Secondes</b> / lieu</div>
                    <div class="bg-white/5 p-3 rounded">üåç <b>10 Manches</b></div>
                    <div class="bg-white/5 p-3 rounded">üéØ <b>5000 Pts</b> max</div>
                    <div class="bg-white/5 p-3 rounded">üí∞ <b>100% Gratuit</b></div>
                </div>

                <button onclick="startGame()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-xl uppercase shadow-lg shadow-green-900/50 transition transform hover:scale-[1.02]">
                    Jouer Maintenant
                </button>
            </div>
        </div>
    </div>

    <!-- JEU -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <div id="panorama"></div>

        <div id="guess-map-wrapper">
            <div id="guess-map"></div>
            <button id="btn-guess" onclick="submitGuess()">VALIDER</button>
        </div>
    </div>

    <!-- INTERMISSION / LEADERBOARD TEMPORAIRE -->
    <div id="intermission-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-md w-full animate-in fade-in zoom-in duration-300">
            <div class="text-6xl mb-4" id="intermission-icon">üìç</div>
            <h2 class="text-4xl font-black text-white mb-2" id="intermission-title">R√©sultat</h2>
            
            <div class="my-6">
                <div class="text-sm text-gray-400 uppercase">Distance</div>
                <div class="text-5xl font-mono font-bold text-white mb-4" id="round-distance">---</div>
                
                <div class="text-sm text-gray-400 uppercase">Points Manche</div>
                <div class="text-4xl font-black text-green-400" id="round-score">+0</div>
            </div>

            <div class="w-full bg-white/10 h-1 mt-4 rounded-full overflow-hidden">
                <div id="intermission-timer" class="h-full bg-blue-500 w-full"></div>
            </div>
            <p class="text-xs text-gray-500 mt-2 uppercase">Prochaine manche dans <span id="next-round-sec">7</span>s</p>
        </div>
    </div>

    <!-- FIN DE PARTIE -->
    <div id="end-screen" class="fullscreen-overlay hidden">
        <div class="glass max-w-lg w-full">
            <h2 class="text-4xl font-black text-white mb-6">PARTIE TERMIN√âE</h2>
            
            <div class="bg-black/40 p-6 rounded-2xl border border-white/10 mb-8">
                <div class="text-sm text-gray-400 uppercase mb-1">Score Final</div>
                <div class="text-6xl font-black text-yellow-400" id="final-score">0</div>
                <div class="text-sm text-gray-500 mt-2">sur 50,000 pts possibles</div>
            </div>

            <button onclick="location.reload()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold uppercase transition">
                Rejouer
            </button>
        </div>
    </div>

    <script>
        // --- BASE DE DONN√âES (IMAGES GRATUITES - WIKIMEDIA/PANNELLUM) ---
        // Pour en avoir une "infinit√©", il faudrait une API payante.
        // Ici, j'ai compil√© une liste diversifi√©e. Le code en piochera 10 au hasard.
        const DATABASE = [
            { name: "Alpes Suisses", lat: 46.558, lng: 7.905, pano: "https://pannellum.org/images/alma.jpg" },
            { name: "Londres Biblioth√®que", lat: 51.507, lng: -0.127, pano: "https://pannellum.org/images/bma-0.jpg" },
            { name: "Cerro Torre", lat: -49.293, lng: -73.097, pano: "https://pannellum.org/images/cerro-torre.jpg" },
            { name: "Milan", lat: 45.464, lng: 9.190, pano: "https://upload.wikimedia.org/wikipedia/commons/e/ea/Galleria_Vittorio_Emanuele_II%2C_Milan%2C_Italy_-_360_degree_panoramic_view.jpg" },
            { name: "Grand Canyon", lat: 36.054, lng: -112.140, pano: "https://upload.wikimedia.org/wikipedia/commons/2/21/Grand_Canyon_Horseshoe_Bend_Panorama.jpg" },
            { name: "Paris, Louvre", lat: 48.860, lng: 2.337, pano: "https://upload.wikimedia.org/wikipedia/commons/b/b5/Louvre_Cour_Napol%C3%A9on_panoramic_view%2C_Paris_9_July_2016.jpg" },
            { name: "Place Rouge, Moscou", lat: 55.753, lng: 37.622, pano: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Red_Square_Saint_Basils_Cathedral_GUM_Mosaic_Panorama.jpg/1024px-Red_Square_Saint_Basils_Cathedral_GUM_Mosaic_Panorama.jpg" },
            { name: "Machu Picchu", lat: -13.163, lng: -72.545, pano: "https://upload.wikimedia.org/wikipedia/commons/1/1d/Machu_Picchu_Peru_Panorama.jpg" },
            { name: "Venise", lat: 45.434, lng: 12.339, pano: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Piazza_San_Marco_Venice_September_2015_panorama.jpg/1280px-Piazza_San_Marco_Venice_September_2015_panorama.jpg" },
            { name: "New York Times Square", lat: 40.758, lng: -73.985, pano: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Times_Square_Panorama_2014.jpg/1280px-Times_Square_Panorama_2014.jpg" },
            { name: "Kyoto Temple", lat: 34.995, lng: 135.785, pano: "https://upload.wikimedia.org/wikipedia/commons/e/e0/Kiyomizu-dera_Main_Hall_Panorama.jpg" },
            { name: "Islande Cascade", lat: 63.532, lng: -19.511, pano: "https://upload.wikimedia.org/wikipedia/commons/6/6f/Sk%C3%B3gafoss_waterfall_panorama_2.jpg" },
            { name: "Chateau de Versailles", lat: 48.804, lng: 2.120, pano: "https://upload.wikimedia.org/wikipedia/commons/f/f0/Versailles_Gardens_Panorama_July_2012.jpg" },
            { name: "Sydney Opera", lat: -33.856, lng: 151.215, pano: "https://upload.wikimedia.org/wikipedia/commons/8/82/Sydney_Harbour_Bridge_from_Circular_Quay_Panorama.jpg" },
            { name: "Rome Colis√©e", lat: 41.890, lng: 12.492, pano: "https://upload.wikimedia.org/wikipedia/commons/0/08/Colosseum_interior_panorama_2016.jpg" }
        ];

        // --- VARIABLES DE JEU ---
        let map, viewer, guessMarker, targetMarker, linePoly;
        let currentRound = 1;
        const MAX_ROUNDS = 10;
        const ROUND_TIME = 20; // secondes
        
        let totalScore = 0;
        let currentLoc = null;
        let gameQueue = [];
        let timerInterval;
        let timeLeft;
        let hasGuessed = false;

        // --- LOGIQUE ---

        function startGame() {
            // M√©langer et prendre 10 lieux
            gameQueue = [...DATABASE].sort(() => 0.5 - Math.random()).slice(0, MAX_ROUNDS);
            
            // UI Reset
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            totalScore = 0;
            currentRound = 0;
            updateHUD();
            
            initMap();
            nextRound();
        }

        function initMap() {
            if(map) map.remove();
            map = L.map('guess-map', { zoomControl: false, attributionControl: false }).setView([20, 0], 1);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            map.on('click', (e) => {
                if(hasGuessed) return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                document.getElementById('btn-guess').innerText = "VALIDER";
                document.getElementById('btn-guess').disabled = false;
            });
        }

        function nextRound() {
            if (currentRound >= MAX_ROUNDS) {
                endGame();
                return;
            }

            // Reset √âtat
            currentRound++;
            currentLoc = gameQueue[currentRound - 1];
            hasGuessed = false;
            timeLeft = ROUND_TIME;
            
            // Reset UI
            document.getElementById('guess-map-wrapper').classList.remove('result-mode');
            document.getElementById('btn-guess').disabled = true;
            document.getElementById('btn-guess').innerText = "CLIQUE SUR LA CARTE";
            document.getElementById('intermission-screen').classList.add('hidden');
            
            // Nettoyage Map
            if(guessMarker) map.removeLayer(guessMarker);
            if(targetMarker) map.removeLayer(targetMarker);
            if(linePoly) map.removeLayer(linePoly);
            map.setView([20, 0], 1);
            setTimeout(() => map.invalidateSize(), 500); // Fix bug affichage map

            // Chargement Panorama
            if(viewer) viewer.destroy();
            viewer = pannellum.viewer('panorama', {
                type: 'equirectangular',
                panorama: currentLoc.pano,
                autoLoad: true,
                showControls: false,
                compass: false
            });

            updateHUD();
            startTimer();
        }

        function startTimer() {
            const bar = document.getElementById('timer-bar');
            bar.style.transition = 'none';
            bar.style.width = '100%';
            
            clearInterval(timerInterval);
            
            // Petit d√©lai pour laisser le CSS reflow
            setTimeout(() => {
                bar.style.transition = `width ${ROUND_TIME}s linear`;
                bar.style.width = '0%';
            }, 50);

            timerInterval = setInterval(() => {
                timeLeft--;
                if(timeLeft <= 0) {
                    submitGuess(true); // Time's up
                }
            }, 1000);
        }

        function submitGuess(forceTimeout = false) {
            clearInterval(timerInterval);
            hasGuessed = true;
            document.getElementById('btn-guess').disabled = true;

            let dist = 0;
            let points = 0;
            let guessPos = null;

            if (forceTimeout || !guessMarker) {
                // Pas de guess ou temps √©coul√©
                dist = 20000; // max distance terre approx
                points = 0;
            } else {
                guessPos = guessMarker.getLatLng();
                dist = map.distance(guessPos, [currentLoc.lat, currentLoc.lng]) / 1000; // km
                points = calculateScore(dist);
            }

            totalScore += points;
            updateHUD();

            // Affichage R√©sultat sur Map
            showMapResult(guessPos, [currentLoc.lat, currentLoc.lng]);

            // Attendre 3s pour voir la carte, puis intermission
            setTimeout(() => {
                showIntermission(dist, points);
            }, 3000);
        }

        function calculateScore(km) {
            // Formule style Geoguessr : 5000 * e^(-distance/2000)
            // Si < 50m, 5000pts.
            if(km < 0.05) return 5000;
            const score = Math.round(5000 * Math.exp(-km / 2000));
            return Math.max(0, score);
        }

        function showMapResult(guessPos, targetPos) {
            const wrapper = document.getElementById('guess-map-wrapper');
            wrapper.classList.add('result-mode');
            map.invalidateSize();

            targetMarker = L.marker(targetPos, {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/green-marker.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                })
            }).addTo(map);

            if (guessPos) {
                linePoly = L.polyline([guessPos, targetPos], {color: '#fbbf24', weight: 4, dashArray: '10, 10'}).addTo(map);
                map.fitBounds(linePoly.getBounds().pad(0.2));
            } else {
                map.setView(targetPos, 5);
            }
        }

        function showIntermission(dist, points) {
            const screen = document.getElementById('intermission-screen');
            screen.classList.remove('hidden');

            const distText = dist > 10000 ? "Temps √âcoul√© / Pas de r√©ponse" : 
                             dist < 1 ? Math.round(dist*1000)+" m" : Math.round(dist)+" km";

            document.getElementById('round-distance').innerText = distText;
            document.getElementById('round-score').innerText = "+" + points;

            // Timer de 7s avant next round
            let seconds = 7;
            const nextSpan = document.getElementById('next-round-sec');
            const bar = document.getElementById('intermission-timer');
            
            bar.style.transition = 'none';
            bar.style.width = '100%';
            nextSpan.innerText = seconds;

            setTimeout(() => {
                bar.style.transition = 'width 7s linear';
                bar.style.width = '0%';
            }, 50);

            const intTimer = setInterval(() => {
                seconds--;
                nextSpan.innerText = seconds;
                if(seconds <= 0) {
                    clearInterval(intTimer);
                    nextRound();
                }
            }, 1000);
        }

        function updateHUD() {
            document.getElementById('round-display').innerText = `${currentRound}/${MAX_ROUNDS}`;
            document.getElementById('score-display').innerText = `${totalScore} pts`;
        }

        function endGame() {
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('game-hud').classList.add('hidden');
            document.getElementById('intermission-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = totalScore;
        }

    </script>
</body>
</html>

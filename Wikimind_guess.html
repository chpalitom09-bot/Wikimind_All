<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind Guess - Free Edition</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LEAFLET (Carte OpenSource) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PANNELLUM (Lecteur 360 gratuit) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { bg: '#0f172a', card: '#1e293b', accent: '#3b82f6' }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        
        /* Conteneur 360 */
        #panorama { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 0; }
        .pnlm-load-box { display: none !important; } /* Cacher le loading moche par d√©faut */
        
        /* Carte de guessing flottante */
        #guess-map-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            z-index: 1000;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.8);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            background: #1e293b;
        }
        #guess-map-container:hover {
            width: 500px;
            height: 500px;
        }
        #guess-map { width: 100%; height: 100%; background: #222; }

        /* UI Elements */
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Bouton Valider */
        #btn-guess-container {
            position: absolute; bottom: 15px; left: 0; width: 100%; 
            display: flex; justify-content: center; pointer-events: none; z-index: 1001;
        }
        #btn-guess {
            pointer-events: auto;
            background: #16a34a; color: white;
            font-weight: 800; padding: 12px 30px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border: 2px solid white;
            text-transform: uppercase; font-size: 14px; letter-spacing: 1px;
            transition: all 0.2s;
        }
        #btn-guess:hover { transform: scale(1.05); background: #15803d; }
        #btn-guess:disabled { background: #525252; opacity: 0.7; cursor: not-allowed; }

        /* Custom marker Leaflet */
        .custom-icon { filter: drop-shadow(0 0 5px black); }
    </style>
</head>
<body>

    <!-- HEADER HUD -->
    <header class="fixed top-0 left-0 w-full h-16 z-50 flex items-center justify-between px-6 pointer-events-none">
        <div class="pointer-events-auto bg-black/60 backdrop-blur rounded-full px-4 py-2 flex items-center gap-3 border border-white/10">
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse" id="conn-status"></div>
            <span class="font-bold text-sm tracking-wider">WIKIMIND GUESS (Free)</span>
        </div>
        
        <div class="pointer-events-auto bg-black/60 backdrop-blur rounded-full px-4 py-2 flex items-center gap-4 border border-white/10">
            <button onclick="window.location.href='Wikimind_games.html'" class="text-xs font-bold text-gray-400 hover:text-white">QUITTER</button>
        </div>
    </header>

    <!-- MENU PRINCIPAL -->
    <div id="main-menu" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-2xl max-w-md w-full text-center shadow-2xl border-t border-blue-500/50">
            <h1 class="text-5xl font-black mb-2 italic text-white">üåç GUESS</h1>
            <p class="text-gray-400 mb-8 text-sm">Version Open Source - 100% Gratuit</p>

            <!-- Mode Tabs -->
            <div class="flex gap-2 mb-6 bg-black/40 p-1 rounded-lg">
                <button onclick="setMode('solo')" id="tab-solo" class="flex-1 py-2 rounded font-bold text-xs uppercase bg-blue-600 text-white shadow">Solo</button>
                <button onclick="setMode('online')" id="tab-online" class="flex-1 py-2 rounded font-bold text-xs uppercase text-gray-400 hover:bg-white/5 transition">En Ligne</button>
            </div>

            <!-- Panel Solo -->
            <div id="panel-solo" class="space-y-3">
                <button onclick="startGame('solo')" class="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/50 uppercase tracking-widest hover:scale-[1.02] transition">
                    Jouer Solo
                </button>
            </div>

            <!-- Panel Online -->
            <div id="panel-online" class="hidden space-y-4">
                <button id="btn-create" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl uppercase tracking-widest shadow-lg">
                    Cr√©er Partie
                </button>
                
                <div class="flex gap-2">
                    <input type="text" id="input-code" placeholder="CODE" class="flex-1 bg-black/50 border border-white/20 rounded-xl px-4 text-center font-mono text-white focus:border-blue-500 outline-none uppercase h-12">
                    <button id="btn-join" class="px-6 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl uppercase text-sm h-12">Join</button>
                </div>

                <div id="lobby-ui" class="hidden mt-4 bg-white/5 p-4 rounded-xl border border-dashed border-white/20">
                    <div class="text-xs text-gray-400 uppercase mb-1">Code Partie</div>
                    <div id="display-code" class="text-3xl font-mono font-black text-blue-400 select-all cursor-pointer bg-black/50 rounded p-2">----</div>
                    <div class="mt-2 text-[10px] text-yellow-300 animate-pulse">En attente d'un joueur...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JEU -->
    <div id="game-ui" class="hidden w-full h-full relative">
        <!-- Lecteur 360 -->
        <div id="panorama"></div>

        <!-- Carte -->
        <div id="guess-map-container">
            <div id="guess-map"></div>
            <div id="btn-guess-container">
                <button id="btn-guess">VALIDER GUESS</button>
            </div>
        </div>
    </div>

    <!-- RESULTAT MODAL -->
    <div id="result-modal" class="hidden fixed inset-0 z-[3000] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass-panel p-6 rounded-2xl max-w-lg w-full text-center relative border border-white/10">
            <div class="text-6xl mb-4">üìç</div>
            <h2 class="text-3xl font-black text-white mb-1 uppercase" id="result-title">R√©sultat</h2>
            <div class="text-5xl font-mono font-bold text-green-400 mb-4" id="result-distance">0 km</div>
            
            <div class="flex justify-around mb-6 text-sm text-gray-400 bg-black/30 p-4 rounded-xl border border-white/5">
                <div>
                    <div class="font-bold text-white text-xl" id="p1-score">---</div>
                    <div class="text-[10px] uppercase tracking-wider mt-1">Moi</div>
                </div>
                <div id="p2-score-container" class="hidden border-l border-white/10 pl-8">
                    <div class="font-bold text-white text-xl" id="p2-score">---</div>
                    <div class="text-[10px] uppercase tracking-wider mt-1">Adversaire</div>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-white text-black font-bold py-4 rounded-xl uppercase text-xs tracking-widest hover:bg-gray-200 transition">Retour Menu</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // FIREBASE CONFIG (Remet ta config si elle change)
        const firebaseConfig = {
            apiKey: "AIzaSyC_P0rfBDbRugnh5xKEJG5IE6P6kub6vV8",
            authDomain: "wikimind-guesser.firebaseapp.com",
            databaseURL: "https://wikimind-guesser-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wikimind-guesser",
            storageBucket: "wikimind-guesser.firebasestorage.app",
            messagingSenderId: "977613671463",
            appId: "1:977613671463:web:f7203e96b97cea3b5a5202"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DONN√âES DE JEU (IMAGES 360 GRATUITES) ---
        // On ne peut pas "parcourir" le monde entier gratuitement comme Google.
        // On utilise une liste de lieux pr√©-d√©finis avec des images libres de droits.
        const LOCATIONS = [
            { 
                name: "Alpes Suisses",
                lat: 46.558, lng: 7.905, 
                pano: "https://pannellum.org/images/alma.jpg" 
            },
            {
                name: "Biblioth√®que",
                lat: 51.507, lng: -0.127, // Fake coords for demo
                pano: "https://pannellum.org/images/bma-0.jpg"
            },
            {
                name: "Cerro Torre (Argentine)",
                lat: -49.293, lng: -73.097,
                pano: "https://pannellum.org/images/cerro-torre.jpg"
            },
            // Tu peux ajouter tes propres URLs d'images 360 ici
        ];

        let map, viewer, guessMarker, targetMarker, linePoly;
        let currentTarget = null;
        let gameId = null;
        let myUid = null;
        let gameMode = 'solo';
        let isHost = false;
        let hasGuessed = false;

        // --- AUTH ---
        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                document.getElementById('conn-status').classList.remove('animate-pulse');
            }
        });

        // --- MOTEUR DE JEU ---

        window.startGame = (mode, locationIndex = null) => {
            gameMode = mode;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');

            // 1. Choix du lieu
            let locIndex;
            if (locationIndex !== null) {
                locIndex = locationIndex;
            } else {
                locIndex = Math.floor(Math.random() * LOCATIONS.length);
            }
            currentTarget = LOCATIONS[locIndex];
            currentTarget.index = locIndex; // Stocker l'index pour le multi

            // 2. Initialiser Pannellum (Vue 360)
            if(viewer) viewer.destroy();
            viewer = pannellum.viewer('panorama', {
                type: 'equirectangular',
                panorama: currentTarget.pano,
                autoLoad: true,
                showControls: false // Pour plus d'immersion
            });

            // 3. Initialiser Leaflet (Carte OpenSource)
            if(map) {
                map.remove(); // Reset map
                guessMarker = null;
            }
            
            map = L.map('guess-map', { zoomControl: false }).setView([20, 0], 1);
            
            // Fond de carte sombre (CartoDB Dark Matter)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Clic sur la carte
            map.on('click', function(e) {
                if(hasGuessed) return;
                placeGuessMarker(e.latlng);
            });

            hasGuessed = false;
            document.getElementById('btn-guess').innerText = "VALIDER GUESS";
            document.getElementById('btn-guess').disabled = false;
            document.getElementById('btn-guess').onclick = submitGuess;
        };

        function placeGuessMarker(latlng) {
            if (guessMarker) map.removeLayer(guessMarker);
            
            guessMarker = L.marker(latlng, {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/red-marker.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    shadowSize: [41, 41]
                })
            }).addTo(map);
        }

        function submitGuess() {
            if (!guessMarker || hasGuessed) {
                if(!guessMarker) alert("Place un point sur la carte !");
                return;
            }
            hasGuessed = true;
            const btn = document.getElementById('btn-guess');
            btn.innerText = "CALCUL...";
            btn.disabled = true;

            const guessPos = guessMarker.getLatLng();
            
            // Calcul distance
            const distance = map.distance(guessPos, [currentTarget.lat, currentTarget.lng]) / 1000;

            showResultOnMap(guessPos, [currentTarget.lat, currentTarget.lng]);

            if (gameMode === 'solo') {
                setTimeout(() => showEndScreen(distance, null), 2000);
            } else {
                const updates = {};
                updates[`games_geo/${gameId}/guesses/${myUid}`] = {
                    distance: distance,
                    lat: guessPos.lat,
                    lng: guessPos.lng
                };
                update(ref(db), updates);
            }
        }

        function showResultOnMap(guessPos, targetPos) {
            // Agrandir la carte
            const container = document.getElementById('guess-map-container');
            container.style.width = "80vw";
            container.style.height = "60vh";
            container.style.bottom = "50%";
            container.style.right = "50%";
            container.style.transform = "translate(50%, 50%)";
            map.invalidateSize(); // Force refresh leaflet

            // Marqueur vert pour la cible
            targetMarker = L.marker(targetPos, {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/green-marker.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                })
            }).addTo(map);

            // Ligne
            linePoly = L.polyline([guessPos, targetPos], {color: 'yellow', weight: 3, dashArray: '10, 10'}).addTo(map);

            // Zoomer pour voir tout
            const group = new L.featureGroup([guessMarker, targetMarker]);
            map.fitBounds(group.getBounds().pad(0.2));
        }

        function showEndScreen(myDist, oppDist) {
            document.getElementById('result-modal').classList.remove('hidden');
            const formatDist = (d) => d < 1 ? Math.round(d * 1000) + " m" : Math.round(d) + " km";
            
            document.getElementById('result-distance').innerText = formatDist(myDist);
            document.getElementById('p1-score').innerText = formatDist(myDist);

            if (oppDist !== null) {
                document.getElementById('p2-score-container').classList.remove('hidden');
                document.getElementById('p2-score').innerText = formatDist(oppDist);
                
                if (myDist < oppDist) {
                    document.getElementById('result-title').innerText = "VICTOIRE !";
                    document.getElementById('result-title').className = "text-3xl font-black text-green-500 mb-1 uppercase";
                } else {
                    document.getElementById('result-title').innerText = "D√âFAITE...";
                    document.getElementById('result-title').className = "text-3xl font-black text-red-500 mb-1 uppercase";
                }
            }
        }

        // --- LOGIQUE MULTIJOUEUR ---
        document.getElementById('btn-create').addEventListener('click', () => {
            gameId = Math.random().toString(36).substring(2, 6).toUpperCase();
            isHost = true;
            // Choisir un index al√©atoire pour le multi
            const randomLocIndex = Math.floor(Math.random() * LOCATIONS.length);

            set(ref(db, 'games_geo/' + gameId), {
                host: myUid,
                status: 'waiting',
                targetIndex: randomLocIndex // On envoie l'index, pas tout l'objet
            });

            document.getElementById('btn-create').classList.add('hidden');
            document.getElementById('lobby-ui').classList.remove('hidden');
            document.getElementById('display-code').innerText = gameId;

            listenGame(gameId);
        });

        document.getElementById('btn-join').addEventListener('click', async () => {
            const code = document.getElementById('input-code').value.toUpperCase().trim();
            if(!code) return;
            const gRef = ref(db, 'games_geo/' + code);
            const snap = await get(gRef);
            if(snap.exists() && snap.val().status === 'waiting') {
                gameId = code;
                isHost = false;
                update(gRef, { guest: myUid, status: 'playing' });
                // Le client lance avec le m√™me index que l'h√¥te
                startGame('online', snap.val().targetIndex);
                listenGame(code);
            }
        });

        function listenGame(id) {
            onValue(ref(db, 'games_geo/' + id), (snap) => {
                const data = snap.val();
                if(!data) return;
                
                // Si je suis l'host et que le jeu passe en "playing", je lance ma partie
                if(isHost && data.status === 'playing' && document.getElementById('game-ui').classList.contains('hidden')) {
                    startGame('online', data.targetIndex);
                }

                if(data.guesses && data.guesses[data.host] && data.guesses[data.guest]) {
                    const myG = data.guesses[myUid];
                    const oppUid = isHost ? data.guest : data.host;
                    const oppG = data.guesses[oppUid];
                    if(myG && oppG) {
                        setTimeout(() => showEndScreen(myG.distance, oppG.distance), 1000);
                    }
                }
            });
        }

        window.setMode = (mode) => {
            document.getElementById('panel-solo').classList.toggle('hidden', mode !== 'solo');
            document.getElementById('panel-online').classList.toggle('hidden', mode !== 'online');
            if(mode === 'online') {
                document.getElementById('tab-online').className = "flex-1 py-2 rounded font-bold text-xs uppercase bg-purple-600 text-white shadow transition-all";
                document.getElementById('tab-solo').className = "flex-1 py-2 rounded font-bold text-xs uppercase text-gray-400 hover:bg-white/5 transition";
            } else {
                document.getElementById('tab-solo').className = "flex-1 py-2 rounded font-bold text-xs uppercase bg-blue-600 text-white shadow transition-all";
                document.getElementById('tab-online').className = "flex-1 py-2 rounded font-bold text-xs uppercase text-gray-400 hover:bg-white/5 transition";
            }
        };
    </script>
</body>
</html>

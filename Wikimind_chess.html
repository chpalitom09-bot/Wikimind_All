<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind Chess - Mobile & Online</title>

    <!-- 1. JQUERY -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 2. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { bg: '#050505', card: '#111111', border: '#222222' }
                }
            }
        }
    </script>

    <!-- 3. CHESS LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; overscroll-behavior: none; }
        
        /* STYLE DU PLATEAU */
        .board-b72b1 { border: 2px solid #333; border-radius: 4px; }
        .white-1e1d7 { background-color: #ebecd0; color: #779556; }
        .black-3c85d { background-color: #779556; color: #ebecd0; }
        
        /* EMP√äCHER LE SCROLL SUR MOBILE PENDANT LE JEU */
        #myBoard { touch-action: none; }

        /* INDICATEURS */
        .highlight-move { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- HEADER COMPACT -->
    <header class="h-14 border-b border-border bg-[#0a0a0a] flex items-center justify-between px-4 z-20 shrink-0">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="w-8 h-8 bg-white text-black rounded flex items-center justify-center font-black">W</div>
            <span class="text-sm font-black uppercase hidden md:block">WikiMind Chess</span>
        </div>
        
        <!-- PROFIL JOUEUR -->
        <div class="flex items-center gap-3 bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
            <div class="w-2 h-2 rounded-full bg-red-500" id="conn-status"></div>
            <div class="flex flex-col text-right">
                <span id="user-name" class="text-xs font-bold text-white max-w-[100px] truncate">Connexion...</span>
                <span id="user-elo" class="text-[10px] font-mono text-blue-400">---</span>
            </div>
        </div>
    </header>

    <!-- LAYOUT PRINCIPAL -->
    <div class="flex-grow flex flex-col lg:flex-row h-full overflow-hidden relative">

        <!-- ZONE DE JEU (PLATEAU) - En premier sur mobile -->
        <div class="flex-grow bg-[#050505] relative flex flex-col items-center justify-start lg:justify-center p-2 lg:p-4 order-1 lg:order-2">
            
            <!-- INFO ADVERSAIRE (MOBILE) -->
            <div id="top-hud" class="w-full max-w-[500px] flex justify-between items-end mb-2 px-2 h-10">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-lg">üë§</div>
                    <div>
                        <div id="opponent-name-hud" class="text-xs font-bold text-gray-400">Adversaire</div>
                        <div id="opponent-elo-hud" class="text-[10px] text-gray-600">---</div>
                    </div>
                </div>
                <div id="turn-indicator" class="px-3 py-1 bg-zinc-900 rounded text-[10px] font-bold uppercase text-gray-500 border border-zinc-800">
                    En attente
                </div>
            </div>

            <!-- CONTENEUR PLATEAU RESPONSIVE -->
            <!-- aspect-square assure que c'est toujours un carr√© -->
            <div id="board-wrapper" class="w-full max-w-[90vw] lg:max-w-[550px] aspect-square relative shadow-2xl shadow-black">
                <div id="myBoard" class="w-full h-full"></div>
            </div>

            <!-- INFO JOUEUR (MOBILE) -->
            <div class="w-full max-w-[500px] flex justify-between items-start mt-2 px-2">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-lg border border-blue-900/50">ME</div>
                    <div>
                        <div id="my-name-hud" class="text-xs font-bold text-white">Moi</div>
                        <div id="my-elo-hud" class="text-[10px] text-blue-400">---</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR CONTROLES - En bas sur mobile (Scrollable) -->
        <div class="w-full lg:w-96 border-t lg:border-t-0 lg:border-r border-border bg-[#0a0a0a] flex flex-col z-10 order-2 lg:order-1 h-[40vh] lg:h-auto shrink-0">
            
            <!-- ONGLETS -->
            <div class="flex border-b border-border text-xs font-bold uppercase tracking-widest text-center shrink-0">
                <button onclick="switchTab('online')" id="tab-online" class="flex-1 py-3 bg-zinc-900 text-white border-b-2 border-blue-500">En Ligne</button>
                <button onclick="switchTab('local')" id="tab-local" class="flex-1 py-3 hover:bg-zinc-900 text-gray-500">Solo / Bot</button>
            </div>

            <div class="flex-grow overflow-y-auto p-4 relative">
                
                <!-- CONTENU: EN LIGNE -->
                <div id="panel-online" class="space-y-4">
                    <div class="bg-blue-900/10 p-4 rounded-xl border border-blue-900/30">
                        <h3 class="text-xs font-bold uppercase text-blue-400 mb-2">1. Cr√©er une partie</h3>
                        <button id="btn-create" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg text-xs uppercase tracking-widest shadow-lg active:scale-95 transition">
                            G√©n√©rer Code
                        </button>
                        
                        <div id="lobby-wait" class="hidden mt-3 text-center animate-fade-in">
                            <p class="text-[10px] text-gray-400 mb-1">CODE √Ä PARTAGER :</p>
                            <div id="display-code" class="text-2xl font-mono font-black text-white bg-black p-2 rounded select-all border border-blue-500/50">----</div>
                            <div class="mt-2 text-[10px] text-blue-300 animate-pulse">En attente d'un joueur...</div>
                        </div>
                    </div>

                    <div class="text-center text-[10px] font-bold text-gray-600">- OU -</div>

                    <div class="bg-zinc-900/50 p-4 rounded-xl border border-zinc-800">
                        <h3 class="text-xs font-bold uppercase text-green-400 mb-2">2. Rejoindre</h3>
                        <div class="flex gap-2">
                            <input type="text" id="input-code" placeholder="CODE ICI" class="flex-1 bg-black border border-zinc-700 rounded-lg px-3 text-center uppercase font-mono text-white focus:border-green-500 outline-none">
                            <button id="btn-join" class="px-4 bg-green-600 text-white font-bold rounded-lg text-xs uppercase active:scale-95 transition">GO</button>
                        </div>
                    </div>
                </div>

                <!-- CONTENU: LOCAL -->
                <div id="panel-local" class="hidden space-y-4">
                    <button onclick="startBotGame()" class="w-full p-4 rounded-xl bg-zinc-800 border border-zinc-700 text-left active:scale-95 transition">
                        <div class="font-bold text-sm text-white">ü§ñ Vs Mistral AI</div>
                        <div class="text-xs text-gray-400">Entra√Ænement intelligent</div>
                    </button>
                    <button onclick="startLocalGame()" class="w-full p-4 rounded-xl bg-black border border-zinc-800 text-left active:scale-95 transition">
                        <div class="font-bold text-sm text-white">üë• 1 vs 1 Local</div>
                        <div class="text-xs text-gray-400">Sur le m√™me √©cran</div>
                    </button>
                </div>

                <!-- LOGS -->
                <div id="logs-container" class="mt-4 p-3 bg-black rounded border border-zinc-800 h-32 overflow-y-auto text-[10px] font-mono text-gray-400">
                    <div>> Syst√®me pr√™t.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FIN DE PARTIE -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-700 p-6 rounded-2xl text-center max-w-sm w-full">
            <div class="text-4xl mb-2">üèÅ</div>
            <h2 id="result-title" class="text-2xl font-black uppercase text-white mb-2">FIN</h2>
            <p id="result-desc" class="text-sm text-gray-400 mb-4">R√©sultat de la partie</p>
            <div id="elo-change" class="text-lg font-bold font-mono mb-6"></div>
            <button onclick="location.reload()" class="w-full bg-white text-black font-bold py-3 rounded-xl uppercase text-xs tracking-widest">Nouvelle Partie</button>
        </div>
    </div>

    <!-- LOGIQUE JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCy5oWMLf1hQmFgAqZDeNPJmfQj71u6Wio",
            authDomain: "wikimindchess.firebaseapp.com",
            databaseURL: "https://wikimindchess-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wikimindchess",
            storageBucket: "wikimindchess.firebasestorage.app",
            messagingSenderId: "78126540427",
            appId: "1:78126540427:web:a49673fd3148988e02d68e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const MISTRAL_API_KEY = "O2qQ4mSRs2cyQ2osownAGbGq9foyvPXR";

        // VARIABLES JEU
        let game = new Chess();
        let board = null;
        let myUid = null;
        let myName = "Guest_" + Math.floor(Math.random()*1000);
        let myElo = 1200;
        let gameId = null;
        let playerColor = 'w'; // 'w' (cr√©ateur) ou 'b' (rejoignant)
        let gameMode = 'local'; // 'local', 'bot', 'online'
        let isEngineThinking = false;

        // AUTHENTIFICATION
        signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                myUid = user.uid;
                document.getElementById('conn-status').classList.replace('bg-red-500', 'bg-green-500');
                
                // R√©cup√©rer ELO ou cr√©er profil
                const userRef = ref(db, 'users/' + myUid);
                const snapshot = await get(userRef);
                if(snapshot.exists()) {
                    myElo = snapshot.val().elo || 1200;
                } else {
                    set(userRef, { name: myName, elo: 1200 });
                }
                
                updateHud();
                log("Connect√©: " + myName);
            }
        });

        // FONCTIONS D'AFFICHAGE
        function updateHud() {
            document.getElementById('user-name').innerText = myName;
            document.getElementById('user-elo').innerText = myElo;
            document.getElementById('my-name-hud').innerText = myName;
            document.getElementById('my-elo-hud').innerText = myElo;
        }

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            const container = document.getElementById('logs-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function updateTurnIndicator() {
            const el = document.getElementById('turn-indicator');
            const turn = game.turn() === 'w' ? 'Blancs' : 'Noirs';
            
            if (gameMode === 'online') {
                if (game.turn() === playerColor) {
                    el.innerText = "√Ä TOI DE JOUER";
                    el.className = "px-3 py-1 bg-green-600 rounded text-[10px] font-bold uppercase text-white animate-pulse";
                } else {
                    el.innerText = "ADVERSAIRE...";
                    el.className = "px-3 py-1 bg-zinc-800 rounded text-[10px] font-bold uppercase text-gray-500";
                }
            } else {
                el.innerText = `Tour : ${turn}`;
                el.className = "px-3 py-1 bg-zinc-800 rounded text-[10px] font-bold uppercase text-white";
            }
        }

        // --- GESTION DU PLATEAU (RESPONSIVE) ---
        function initBoard() {
            // Configuration de base
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            
            board = Chessboard('myBoard', config);
            
            // MAGIC FIX MOBILE: Observer la taille du conteneur et redimensionner le plateau
            const resizeObserver = new ResizeObserver(() => {
                board.resize();
            });
            resizeObserver.observe(document.getElementById('board-wrapper'));
            
            // Double s√©curit√©
            window.addEventListener('resize', board.resize);
            setTimeout(board.resize, 200);
        }

        // --- LOGIQUE DE JEU ---
        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            
            // ONLINE RULES
            if (gameMode === 'online') {
                // Je ne peux bouger que mes pi√®ces
                if ((playerColor === 'w' && piece.search(/^b/) !== -1) ||
                    (playerColor === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
                // Je ne peux bouger que si c'est mon tour
                if ((game.turn() === 'w' && playerColor !== 'w') ||
                    (game.turn() === 'b' && playerColor !== 'b')) {
                    return false;
                }
            }
            // BOT RULES
            if (gameMode === 'bot' && piece.search(/^b/) !== -1) return false;
        }

        function onDrop(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            updateTurnIndicator();

            // ACTIONS SELON MODE
            if (gameMode === 'online') {
                // Envoyer coup √† Firebase
                update(ref(db, 'games/' + gameId), {
                    fen: game.fen(),
                    turn: game.turn()
                });
            } else if (gameMode === 'bot') {
                makeBotMove();
            }
        }

        // --- MULTIJOUEUR ---
        
        // 1. Cr√©er
        document.getElementById('btn-create').addEventListener('click', () => {
            gameId = Math.random().toString(36).substring(2, 6).toUpperCase();
            playerColor = 'w';
            gameMode = 'online';
            
            game.reset();
            board.start();
            board.orientation('white');

            set(ref(db, 'games/' + gameId), {
                white: myUid,
                whiteName: myName,
                whiteElo: myElo,
                fen: 'start',
                status: 'waiting'
            });

            document.getElementById('btn-create').classList.add('hidden');
            document.getElementById('lobby-wait').classList.remove('hidden');
            document.getElementById('display-code').innerText = gameId;
            log(`Partie cr√©√©e: ${gameId}`);

            listenGame(gameId);
        });

        // 2. Rejoindre
        document.getElementById('btn-join').addEventListener('click', async () => {
            const code = document.getElementById('input-code').value.toUpperCase().trim();
            if(!code) return;

            const gRef = ref(db, 'games/' + code);
            const snap = await get(gRef);

            if(snap.exists() && snap.val().status === 'waiting') {
                gameId = code;
                playerColor = 'b';
                gameMode = 'online';

                update(gRef, {
                    black: myUid,
                    blackName: myName,
                    blackElo: myElo,
                    status: 'active'
                });

                game.reset();
                board.start();
                board.orientation('black');
                log("Partie rejointe !");
                
                // Mettre √† jour HUD adversaire
                document.getElementById('opponent-name-hud').innerText = snap.val().whiteName;
                document.getElementById('opponent-elo-hud').innerText = snap.val().whiteElo;

                listenGame(code);
            } else {
                log("Erreur: Code invalide ou partie pleine.");
            }
        });

        // 3. √âcouter (Sync)
        function listenGame(id) {
            const gRef = ref(db, 'games/' + id);
            
            onValue(gRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                // Si l'adversaire arrive (pour le cr√©ateur)
                if(data.status === 'active' && playerColor === 'w' && !document.getElementById('lobby-wait').classList.contains('hidden')) {
                     document.getElementById('lobby-wait').classList.add('hidden');
                     document.getElementById('btn-create').innerText = "PARTIE EN COURS";
                     document.getElementById('opponent-name-hud').innerText = data.blackName;
                     document.getElementById('opponent-elo-hud').innerText = data.blackElo;
                     log("Adversaire connect√© !");
                }

                // Synchronisation du plateau
                // Si le FEN re√ßu est diff√©rent de mon jeu actuel
                if (data.fen && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen); // Animation fluide
                    updateTurnIndicator();
                    checkGameOverOnline();
                }
            });
        }
        
        function checkGameOverOnline() {
            if(game.game_over()) {
                let title = "Match Nul";
                let desc = "Pat ou mat√©riel insuffisant";
                
                if (game.in_checkmate()) {
                    // Si c'est √† moi de jouer et je suis mat, j'ai perdu
                    if (game.turn() === playerColor) {
                        title = "D√âFAITE";
                        desc = "Vous avez perdu.";
                        updateElo(false);
                    } else {
                        title = "VICTOIRE";
                        desc = "Bien jou√© !";
                        updateElo(true);
                    }
                }
                showEndScreen(title, desc);
            }
        }

        async function updateElo(isWin) {
            if(!gameId) return;
            // Calcul simple pour la d√©mo (+10 ou -10)
            // Dans une vraie app, on ferait le calcul serveur ou plus complexe ici
            const change = isWin ? 10 : -10;
            const newElo = myElo + change;
            
            // Mise √† jour locale
            myElo = newElo;
            update(ref(db, 'users/' + myUid), { elo: newElo });
            
            const color = isWin ? "text-green-500" : "text-red-500";
            const sign = isWin ? "+" : "";
            document.getElementById('elo-change').innerHTML = `<span class="${color}">${sign}${change} ELO</span> (${newElo})`;
        }

        // --- BOT ---
        window.startBotGame = function() {
            gameMode = 'bot';
            game.reset(); board.start(); board.orientation('white');
            document.getElementById('opponent-name-hud').innerText = "Mistral AI";
            document.getElementById('opponent-elo-hud').innerText = "3000";
            log("Mode Bot activ√©.");
            updateTurnIndicator();
        }

        async function makeBotMove() {
            document.getElementById('turn-indicator').innerText = "MISTRAL R√âFL√âCHIT...";
            const fen = game.fen();
            try {
                const res = await fetch("https://api.mistral.ai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${MISTRAL_API_KEY}` },
                    body: JSON.stringify({
                        model: "mistral-tiny",
                        messages: [{role: "user", content: `Chess FEN: ${fen}. Return best move in SAN only.`}]
                    })
                });
                const data = await res.json();
                let move = data.choices[0].message.content.trim().split(' ')[0].replace('.', '');
                game.move(move);
                board.position(game.fen());
                updateTurnIndicator();
            } catch(e) {
                // Fallback random
                const moves = game.moves();
                game.move(moves[Math.floor(Math.random() * moves.length)]);
                board.position(game.fen());
                updateTurnIndicator();
            }
        }
        
        window.startLocalGame = function() {
            gameMode = 'local';
            game.reset(); board.start();
            log("Mode local.");
        }

        // UI HELPERS
        window.switchTab = function(tab) {
            document.getElementById('panel-online').classList.toggle('hidden', tab !== 'online');
            document.getElementById('panel-local').classList.toggle('hidden', tab !== 'local');
            
            document.getElementById('tab-online').className = tab === 'online' ? "flex-1 py-3 bg-zinc-900 text-white border-b-2 border-blue-500" : "flex-1 py-3 hover:bg-zinc-900 text-gray-500";
            document.getElementById('tab-local').className = tab === 'local' ? "flex-1 py-3 bg-zinc-900 text-white border-b-2 border-blue-500" : "flex-1 py-3 hover:bg-zinc-900 text-gray-500";
            
            // Important: Redimensionner le plateau car le layout peut changer
            setTimeout(board.resize, 100);
        }

        function showEndScreen(title, desc) {
            document.getElementById('game-over-modal').classList.remove('hidden');
            document.getElementById('result-title').innerText = title;
            document.getElementById('result-desc').innerText = desc;
        }

        // INIT
        $(document).ready(initBoard);

    </script>
</body>
</html>

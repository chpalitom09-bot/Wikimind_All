<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMind Chess - Arcade</title>

    <!-- 1. JQUERY (Obligatoire pour Chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 2. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bg: '#050505',
                        card: '#111111',
                        border: '#222222'
                    }
                }
            }
        }
    </script>

    <!-- 3. CHESS LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; }
        
        /* Correction Tailwind/Chessboard */
        .board-b72b1 { border: 4px solid #222; border-radius: 4px; }
        .white-1e1d7 { background-color: #e5e5e5; color: #111; }
        .black-3c85d { background-color: #404040; color: #fff; }
        
        /* Animation */
        .highlight-move { box-shadow: inset 0 0 3px 3px yellow; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Loader */
        .loader {
            border: 2px solid #333;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- HEADER -->
    <header class="h-16 border-b border-border bg-[#0a0a0a] flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="w-8 h-8 bg-white text-black rounded flex items-center justify-center font-black">W</div>
            <h1 class="text-lg font-black uppercase italic tracking-tighter">WikiMind Chess</h1>
        </div>
        
        <div id="status-badge" class="px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-xs font-bold uppercase tracking-widest text-gray-400 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-gray-500" id="status-dot"></span>
            <span id="game-status">Pr√™t</span>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex-grow flex flex-col lg:flex-row h-[calc(100vh-64px)]">

        <!-- LEFT SIDEBAR: CONTROLS -->
        <div class="w-full lg:w-80 border-r border-border bg-[#0a0a0a] flex flex-col z-10">
            <div class="p-6 border-b border-border">
                <h2 class="text-xs font-bold uppercase text-gray-500 tracking-widest mb-4">Configuration</h2>
                
                <button onclick="startBotGame()" class="w-full mb-3 p-4 rounded-xl border border-zinc-800 bg-zinc-900 hover:bg-zinc-800 hover:border-zinc-600 transition group text-left relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="relative z-10 flex justify-between items-center mb-1">
                        <span class="font-bold text-sm">ü§ñ Vs Mistral AI</span>
                        <span class="text-[10px] bg-blue-900 text-blue-200 px-2 py-0.5 rounded font-bold">PRO</span>
                    </div>
                    <p class="relative z-10 text-xs text-gray-500 group-hover:text-gray-400">Affrontez le LLM en mode √©checs.</p>
                </button>

                <button onclick="startLocalGame()" class="w-full p-4 rounded-xl border border-zinc-800 bg-black hover:bg-zinc-900 transition group text-left">
                    <div class="font-bold text-sm mb-1">üë• 1 vs 1 Local</div>
                    <p class="text-xs text-gray-500">Jouez √† deux sur le m√™me √©cran.</p>
                </button>
            </div>

            <div class="flex-grow p-6 overflow-y-auto flex flex-col">
                <h3 class="text-xs font-bold uppercase text-gray-500 tracking-widest mb-2">Historique (PGN)</h3>
                <div id="pgn" class="flex-grow font-mono text-xs text-gray-400 bg-[#0f0f0f] p-3 rounded border border-border whitespace-pre-wrap overflow-y-auto">
                    La partie n'a pas commenc√©.
                </div>
            </div>
            
            <div class="p-4 text-center border-t border-border">
                 <button onclick="resetGame()" class="text-xs font-bold uppercase text-red-500 hover:text-red-400 tracking-widest">Abandonner / Reset</button>
            </div>
        </div>

        <!-- CENTER: BOARD AREA -->
        <div class="flex-grow bg-[#050505] relative flex items-center justify-center p-4">
            <!-- Background Decoration -->
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 pointer-events-none"></div>

            <!-- The Board Container -->
            <div class="relative z-10 shadow-2xl shadow-black">
                <div id="myBoard" style="width: 100%; width: 400px; max-width: 600px;"></div>
            </div>

            <!-- Game Over Overlay -->
            <div id="game-over-modal" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
                <div class="bg-zinc-900 border border-zinc-700 p-8 rounded-2xl text-center max-w-sm mx-4 transform scale-100 transition-transform">
                    <div class="text-4xl mb-2">üëë</div>
                    <h2 id="result-title" class="text-2xl font-black uppercase mb-2 text-white">Partie Termin√©e</h2>
                    <p id="result-desc" class="text-gray-400 mb-6 text-sm">Les blancs gagnent par √©chec et mat.</p>
                    <button onclick="location.reload()" class="bg-white text-black px-6 py-3 rounded-full font-bold uppercase text-xs tracking-widest hover:scale-105 transition">Nouvelle Partie</button>
                </div>
            </div>
        </div>

        <!-- RIGHT: CHAT / LOGS -->
        <div class="hidden xl:flex w-80 border-l border-border bg-[#0a0a0a] flex-col">
            <div class="p-4 border-b border-border bg-zinc-900/50">
                <h3 class="text-xs font-bold uppercase text-gray-500 tracking-widest">Mistral Thoughts</h3>
            </div>
            <div id="chat-box" class="flex-grow p-4 space-y-3 overflow-y-auto text-sm">
                <div class="bg-zinc-900 p-3 rounded-lg border border-zinc-800 text-gray-400 text-xs">
                    Bienvenue. S√©lectionnez un mode pour commencer la partie.
                </div>
            </div>
            <div class="p-4 border-t border-border bg-zinc-900/30">
                <div class="flex items-center gap-2">
                    <div class="w-full h-8 bg-zinc-900 rounded border border-zinc-800 text-xs flex items-center px-3 text-gray-600 italic">
                        IA en lecture seule...
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const MISTRAL_API_KEY = "O2qQ4mSRs2cyQ2osownAGbGq9foyvPXR"; // Cl√© fournie (Attention: visible client-side)
        
        let board = null;
        let game = new Chess();
        let mode = 'local'; // 'local' or 'bot'
        let isEngineThinking = false;

        // --- UI FUNCTIONS ---
        function updateStatus() {
            let status = '';
            let moveColor = (game.turn() === 'b') ? 'Noirs' : 'Blancs';

            // Checkmate?
            if (game.in_checkmate()) {
                status = 'Mat ! ' + moveColor + ' perdent.';
                showGameOver('√âchec et Mat', (game.turn() === 'b' ? 'Les Blancs' : 'Les Noirs') + ' remportent la victoire.');
            }
            // Draw?
            else if (game.in_draw()) {
                status = 'Match Nul';
                showGameOver('Match Nul', 'Pat, r√©p√©tition ou mat√©riel insuffisant.');
            }
            // Game still on
            else {
                status = 'Tour des ' + moveColor;
                if (game.in_check()) {
                    status += ' (√âchec)';
                }
            }

            // Update DOM
            $('#game-status').text(status);
            $('#pgn').text(game.pgn());
            
            // Status Dot Color
            const dot = document.getElementById('status-dot');
            if (game.game_over()) dot.className = "w-2 h-2 rounded-full bg-red-500";
            else if (isEngineThinking) dot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            else dot.className = "w-2 h-2 rounded-full bg-green-500";
        }

        function showGameOver(title, desc) {
            document.getElementById('game-over-modal').classList.remove('hidden');
            document.getElementById('result-title').innerText = title;
            document.getElementById('result-desc').innerText = desc;
        }

        function addLog(message, isAi = false) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = isAi 
                ? "bg-blue-900/20 p-3 rounded-lg border border-blue-900/50 text-blue-200 text-xs"
                : "bg-zinc-900 p-3 rounded-lg border border-zinc-800 text-gray-300 text-xs";
            div.innerHTML = message;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- CHESS LOGIC ---
        function onDragStart (source, piece, position, orientation) {
            if (game.game_over()) return false;
            if (isEngineThinking) return false; // Bloquer pendant que l'IA r√©fl√©chit

            // En mode Bot, on ne peut bouger que les Blancs
            if (mode === 'bot' && (game.turn() === 'b' || piece.search(/^b/) !== -1)) {
                return false;
            }
        }

        function onDrop (source, target) {
            // Voir si le coup est l√©gal
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: Promotion auto en Dame pour simplifier
            });

            // Si ill√©gal, snapback
            if (move === null) return 'snapback';

            updateStatus();

            // Si c'est le mode Bot et que le coup est valide
            if (mode === 'bot' && !game.game_over()) {
                makeBotMove();
            }
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        // --- MISTRAL AI LOGIC ---
        async function makeBotMove() {
            isEngineThinking = true;
            updateStatus();
            addLog('<div class="flex items-center gap-2"><div class="loader"></div> Mistral analyse la position...</div>', true);

            const fen = game.fen();
            const legalMoves = game.moves();
            
            // Construction du prompt pour le LLM
            const prompt = `You are a Grandmaster chess engine.
            Current FEN position: "${fen}".
            Possible legal moves: ${JSON.stringify(legalMoves)}.
            
            Task: detailed analysis of the position and pick the single best move to win.
            
            Output format: Just the SAN move (e.g. "Nf3" or "e4") nothing else. Do not explain.`;

            try {
                const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "mistral-tiny", // Mod√®le rapide
                        messages: [{role: "user", content: prompt}],
                        temperature: 0.1 // Tr√®s froid pour la logique
                    })
                });

                const data = await response.json();
                
                if(data.choices && data.choices.length > 0) {
                    let botMoveSan = data.choices[0].message.content.trim();
                    // Nettoyage (enl√®ve les points, espaces, etc)
                    botMoveSan = botMoveSan.replace(/[\n\r\s]/g, '').replace('.', '');
                    
                    console.log("Mistral propose : ", botMoveSan);

                    // Tenter de jouer le coup
                    const move = game.move(botMoveSan);
                    
                    if (move === null) {
                        throw new Error("Coup ill√©gal sugg√©r√© par l'IA: " + botMoveSan);
                    } else {
                        addLog(`J'ai jou√© <strong>${botMoveSan}</strong>.`, true);
                    }
                } else {
                    throw new Error("Pas de r√©ponse de l'API");
                }

            } catch (error) {
                console.error("Erreur IA:", error);
                addLog("Oups, je suis confus. Je joue un coup au hasard.", true);
                
                // Fallback : Coup au hasard si l'IA plante
                const randomMove = legalMoves[Math.floor(Math.random() * legalMoves.length)];
                game.move(randomMove);
            }

            board.position(game.fen());
            isEngineThinking = false;
            updateStatus();
        }

        // --- INITIALIZATION ---
        $(document).ready(function() {
            var config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            
            // Initialisation du plateau
            board = Chessboard('myBoard', config);
            
            // Responsive : Redimensionner le plateau si la fen√™tre change
            $(window).resize(function() {
                board.resize();
            });

            // Initial status
            updateStatus();
        });

        // --- BUTTON ACTIONS ---
        window.startBotGame = function() {
            game.reset();
            board.start();
            mode = 'bot';
            isEngineThinking = false;
            addLog("Partie contre Mistral AI commenc√©e. Bonne chance !", true);
            updateStatus();
        };

        window.startLocalGame = function() {
            game.reset();
            board.start();
            mode = 'local';
            addLog("Mode 1 vs 1 local activ√©.");
            updateStatus();
        };

        window.resetGame = function() {
            game.reset();
            board.start();
            addLog("Plateau r√©initialis√©.");
            updateStatus();
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-29XYBNJ2CB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-29XYBNJ2CB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind Scan - Analyse IA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --text: #111111;
            --accent: #000000;
            --scan-color: #00ff00;
        }

        .dark-mode {
            --bg: #0f0f0f;
            --text: #eeeeee;
            --accent: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.4s ease;
            overflow-x: hidden;
            overscroll-behavior: none;
        }

        /* Grain Texture */
        .bg-grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 0;
        }

        /* Transitions */
        .view-container {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .view-container.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Editor & Canvas */
        .editor-container {
            position: relative;
            width: 100%;
            height: 60vh; /* Hauteur fixe pour √©viter les sauts */
            border-radius: 24px;
            background: #111;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            touch-action: none;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: crosshair;
        }

        /* --- SCANNER ANIMATIONS --- */
        .scanner-overlay {
            position: absolute; inset: 0;
            background: rgba(0, 20, 0, 0.3);
            z-index: 20;
            display: none; /* Activ√© via JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scan-grid {
            position: absolute; inset: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.2) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
        }

        .scan-beam {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 5px;
            background: #00ff00;
            box-shadow: 0 0 15px #00ff00, 0 0 30px #00ff00;
            animation: scanMove 2s linear infinite;
        }

        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .scan-text {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border: 1px solid #00ff00;
            color: #00ff00;
            border-radius: 4px;
            margin-top: 20px;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 12px;
            animation: blink 0.5s infinite alternate;
        }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

        /* Rarity Bar */
        .rarity-bar {
            height: 8px; border-radius: 4px; background: #eee;
            overflow: hidden; position: relative;
        }
        .dark-mode .rarity-bar { background: #333; }
        
        .rarity-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #4ade80 0%, #facc15 50%, #ef4444 100%);
            transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen relative p-4 md:p-6">
    <div class="bg-grain"></div>

    <!-- HEADER -->
    <header class="fixed top-0 left-0 w-full z-50 p-6 flex justify-between items-center bg-gradient-to-b from-[var(--bg)] to-transparent pointer-events-none">
        <a href="index.html" class="pointer-events-auto flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-[var(--text)] transition">
            <div class="w-8 h-8 bg-[var(--text)] text-[var(--bg)] rounded-lg flex items-center justify-center font-black">‚Üê</div>
        </a>
        <div class="flex items-center gap-2 pointer-events-auto">
            <h1 class="text-xl font-black uppercase tracking-tighter italic">WikiMind <span class="text-blue-500">Scan</span></h1>
        </div>
        <button onclick="toggleTheme()" class="pointer-events-auto w-8 h-8 rounded-full border border-gray-300 dark:border-gray-700 flex items-center justify-center bg-[var(--bg)]">
            <svg id="theme-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-24 pb-10 w-full max-w-2xl mx-auto z-10">

        <!-- VIEW 1: UPLOAD -->
        <div id="view-upload" class="view-container active text-center">
            <h2 class="text-3xl md:text-5xl font-black tracking-tight mb-4">Analysez le monde.</h2>
            <p class="text-gray-500 mb-12">Prenez une photo ou importez une image. L'IA d√©tectera l'objet, son prix et sa raret√©.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Camera -->
                <label class="cursor-pointer group relative overflow-hidden rounded-3xl bg-gray-50 dark:bg-[#161616] border border-gray-200 dark:border-[#252525] p-8 h-64 flex flex-col items-center justify-center hover:border-black dark:hover:border-white transition-all shadow-sm hover:shadow-xl">
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(this)">
                    <div class="w-16 h-16 mb-4 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform duration-300">üì∏</div>
                    <span class="font-bold text-lg">Prendre Photo</span>
                    <span class="text-xs text-gray-500 mt-2 uppercase tracking-widest">Cam√©ra</span>
                </label>

                <!-- Gallery -->
                <label class="cursor-pointer group relative overflow-hidden rounded-3xl bg-gray-50 dark:bg-[#161616] border border-gray-200 dark:border-[#252525] p-8 h-64 flex flex-col items-center justify-center hover:border-black dark:hover:border-white transition-all shadow-sm hover:shadow-xl">
                    <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    <div class="w-16 h-16 mb-4 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform duration-300">üñºÔ∏è</div>
                    <span class="font-bold text-lg">Importer</span>
                    <span class="text-xs text-gray-500 mt-2 uppercase tracking-widest">Galerie</span>
                </label>
            </div>
        </div>

        <!-- VIEW 2: EDITOR & SCAN -->
        <div id="view-editor" class="view-container">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h3 class="text-xl font-bold">Zone d'Analyse</h3>
                    <p class="text-xs text-gray-500">Optionnel : Coloriez l'objet en rouge.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearCanvas()" class="px-3 py-1 text-xs font-bold uppercase border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-zinc-800 transition">Effacer</button>
                    <button onclick="resetUpload()" class="px-3 py-1 text-xs font-bold uppercase text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition">Retour</button>
                </div>
            </div>

            <div class="editor-container">
                <canvas id="image-canvas"></canvas>
                
                <!-- SCANNER OVERLAY -->
                <div id="scanner-ui" class="scanner-overlay">
                    <div class="scan-grid"></div>
                    <div class="scan-beam"></div>
                    <div id="scan-status" class="scan-text">INITIALISATION...</div>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                <button id="btn-analyze" onclick="analyzeImage()" class="w-full md:w-auto px-12 py-4 bg-black dark:bg-white text-white dark:text-black rounded-full font-bold text-sm uppercase tracking-widest hover:scale-105 transition-transform flex items-center justify-center gap-3 shadow-xl shadow-blue-500/20">
                    <span class="text-lg">‚ú®</span> Lancer l'Analyse
                </button>
            </div>
        </div>

        <!-- VIEW 3: RESULTS -->
        <div id="view-result" class="view-container">
            <div class="bg-white dark:bg-[#161616] border border-gray-200 dark:border-[#252525] rounded-3xl overflow-hidden shadow-2xl">
                <!-- Image Preview Header -->
                <div class="h-48 w-full bg-gray-100 dark:bg-black relative overflow-hidden group">
                    <img id="result-img" class="w-full h-full object-cover opacity-80 group-hover:scale-105 transition-transform duration-700" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-6">
                        <div>
                            <span class="text-[10px] font-bold text-green-400 uppercase tracking-widest mb-1 block">Identification confirm√©e</span>
                            <h2 id="res-title" class="text-3xl font-black text-white leading-none">Objet D√©tect√©</h2>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="p-4 rounded-2xl bg-gray-50 dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Valeur Estim√©e</div>
                            <div id="res-price" class="text-2xl font-black text-green-600 dark:text-green-400">--- ‚Ç¨</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-gray-50 dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Indice Raret√©</div>
                            <div class="flex items-center gap-2">
                                <span id="res-rarity-score" class="text-2xl font-black">-/10</span>
                            </div>
                            <div class="rarity-bar mt-2">
                                <div id="res-rarity-fill" class="rarity-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis -->
                    <div class="mb-8">
                        <h3 class="font-bold uppercase tracking-widest text-xs mb-3 text-gray-400">Rapport d'expertise</h3>
                        <div id="res-desc" class="prose prose-sm dark:prose-invert text-gray-600 dark:text-gray-300 leading-relaxed">
                            Chargement...
                        </div>
                    </div>

                    <!-- Fun Stats -->
                    <div class="mb-8">
                         <h3 class="font-bold uppercase tracking-widest text-xs mb-3 text-gray-400">Le Saviez-vous ?</h3>
                         <ul id="res-stats" class="space-y-3 text-sm">
                             <!-- JS injected -->
                         </ul>
                    </div>

                    <button onclick="resetUpload()" class="w-full py-4 border border-gray-200 dark:border-gray-700 rounded-xl font-bold uppercase tracking-widest hover:bg-gray-100 dark:hover:bg-zinc-800 transition">
                        Scanner un autre objet
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- LOGIC -->
    <script>
        // CONFIG & STATE
        const MISTRAL_API_KEY = "krrl5zWdZwHBj8Cy9mtc1oOSBcqv61l2"; 
        let canvas, ctx, originalImage;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // --- GLOBAL FUNCTIONS (Attaching to window to fix ReferenceError) ---

        // 1. UPLOAD HANDLING
        window.handleImageUpload = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    originalImage = new Image();
                    originalImage.onload = () => {
                        setupCanvas();
                        switchView('view-editor');
                    };
                    originalImage.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
        };

        // 2. VIEW SWITCHING
        function switchView(id) {
            document.querySelectorAll('.view-container').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => { 
                    if(!el.classList.contains('active')) el.style.display = 'none'; 
                }, 400);
            });
            
            const target = document.getElementById(id);
            if(target) {
                target.style.display = 'block';
                // Petit d√©lai pour permettre au display:block de s'appliquer avant l'opacit√©
                requestAnimationFrame(() => {
                    target.classList.add('active');
                });
                window.scrollTo({top:0, behavior:'smooth'});
            }
        }

        // 3. CANVAS SETUP
        function setupCanvas() {
            canvas = document.getElementById('image-canvas');
            if(!canvas) return;
            ctx = canvas.getContext('2d');
            
            // Calculer le ratio pour que l'image tienne dans le container
            const container = document.querySelector('.editor-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // On dessine l'image en gardant le ratio
            // On utilise la taille r√©elle de l'image pour le canvas, 
            // mais CSS le fera rentrer dans le container
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            
            ctx.drawImage(originalImage, 0, 0);
        }

        // 4. DRAWING TOOLS
        window.clearCanvas = function() {
            if(!ctx || !originalImage) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0);
        };

        window.resetUpload = function() {
            switchView('view-upload');
            // Reset inputs
            document.querySelectorAll('input[type="file"]').forEach(i => i.value = '');
        };

        // 5. ANALYSIS LOGIC
        window.analyzeImage = async function() {
            const scannerUI = document.getElementById('scanner-ui');
            const scanStatus = document.getElementById('scan-status');
            const btn = document.getElementById('btn-analyze');

            // Start Animation
            scannerUI.style.display = 'flex';
            btn.style.display = 'none';
            
            // Simulate steps
            const steps = ["Calibration capteurs...", "Isolation de l'objet...", "Interrogation Mistral...", "D√©codage donn√©es..."];
            let stepIndex = 0;
            const statusInterval = setInterval(() => {
                if(stepIndex < steps.length) {
                    scanStatus.innerText = steps[stepIndex];
                    stepIndex++;
                }
            }, 800);

            try {
                // Get Image Data
                const base64Image = canvas.toDataURL('image/jpeg', 0.6); // Compression l√©g√®re pour vitesse

                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "pixtral-12b-2409",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    { 
                                        type: "text", 
                                        text: `Analyse l'objet principal de cette image (ou celui entour√© en rouge).
                                        Retourne un JSON pur (sans markdown) :
                                        {
                                            "name": "Nom pr√©cis",
                                            "price_min": "Prix min (nombre)",
                                            "price_max": "Prix max (nombre)",
                                            "currency": "‚Ç¨",
                                            "rarity_score": "1-10",
                                            "description": "Description courte et pr√©cise en fran√ßais.",
                                            "stats": ["Fait 1", "Fait 2", "Fait 3"]
                                        }`
                                    },
                                    { type: "image_url", image_url: base64Image }
                                ]
                            }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                clearInterval(statusInterval);

                if (data.choices && data.choices[0]) {
                    const result = JSON.parse(data.choices[0].message.content);
                    displayResults(result);
                } else {
                    throw new Error("R√©ponse vide de l'IA");
                }

            } catch (error) {
                console.error(error);
                clearInterval(statusInterval);
                scannerUI.style.display = 'none';
                btn.style.display = 'flex';
                alert("Erreur: " + error.message);
            }
        };

        function displayResults(data) {
            document.getElementById('res-title').innerText = data.name || "Objet Inconnu";
            document.getElementById('res-price').innerText = `${data.price_min || 0} - ${data.price_max || 0} ${data.currency || '‚Ç¨'}`;
            
            document.getElementById('res-rarity-score').innerText = `${data.rarity_score || 5}/10`;
            
            document.getElementById('res-desc').innerHTML = marked.parse(data.description || "Pas de description.");

            const statsList = document.getElementById('res-stats');
            statsList.innerHTML = (data.stats || []).map(s => `
                <li class="flex items-start gap-3 bg-gray-50 dark:bg-zinc-900 p-3 rounded-lg">
                    <span class="text-blue-500 font-bold">‚ÑπÔ∏è</span>
                    <span class="text-gray-600 dark:text-gray-400">${s}</span>
                </li>
            `).join('');

            // Set thumbnail
            document.getElementById('result-img').src = canvas.toDataURL();

            // Stop animation & switch
            document.getElementById('scanner-ui').style.display = 'none';
            document.getElementById('btn-analyze').style.display = 'flex';
            
            switchView('view-result');
            
            // Animate bar after switch
            setTimeout(() => {
                document.getElementById('res-rarity-fill').style.width = `${(data.rarity_score || 0) * 10}%`;
            }, 600);
        }

        // 6. THEME
        window.toggleTheme = function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('wikimind_landing_theme', isDark ? 'dark' : 'light');
            
            const path = document.querySelector('#theme-icon path');
            if(isDark) path.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
            else path.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
        };

        // --- INIT EVENTS ---
        window.addEventListener('load', () => {
            canvas = document.getElementById('image-canvas');
            
            // Drawing Logic
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches) {
                    return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
                }
                return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
            };

            const start = (e) => {
                if(!ctx) return;
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            };

            const move = (e) => {
                if (!isDrawing || !ctx) return;
                e.preventDefault(); // Stop scrolling on mobile
                
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.lineWidth = canvas.width / 20; // Dynamic size
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                lastX = pos.x;
                lastY = pos.y;
            };

            const end = () => { isDrawing = false; };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseout', end);
            
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', end);

            // Load saved theme
            if (localStorage.getItem('wikimind_landing_theme') === 'dark') {
                window.toggleTheme();
            }
        });

    </script>
</body>
</html>

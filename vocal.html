<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiMind Voice - Dictée & IA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #111111;
            --card-bg: rgba(249, 250, 251, 0.85);
            --border: #e5e7eb;
            --accent: #2563eb; /* Bleu Wikimind */
            --accent-text: #ffffff;
        }

        .dark-mode {
            --bg: #0f0f0f;
            --text: #eeeeee;
            --card-bg: rgba(22, 22, 22, 0.85);
            --border: #252525;
            --accent: #ffffff;
            --accent-text: #000000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        /* Effet de pulsation pour le micro actif */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(37, 99, 235, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        
        .mic-active {
            animation: pulse-ring 2s infinite;
            background-color: #ef4444 !important; /* Rouge quand ça enregistre */
            border-color: #ef4444 !important;
            color: white !important;
        }

        .ai-loading {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, var(--text) 4%, var(--accent) 25%, var(--text) 36%);
            background-size: 1000px 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* Zone de texte style Wikimind */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">

    <!-- NAVBAR -->
    <header class="fixed top-0 w-full z-50 border-b border-gray-200/50 dark:border-gray-800/50 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 bg-black dark:bg-white text-white dark:text-black rounded-xl flex items-center justify-center font-black text-xl">W</div>
                <h1 class="hidden md:block text-xl font-black uppercase tracking-tighter italic">WikiMind <span class="text-blue-600">Voice</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-zinc-800 transition">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-32 pb-20 px-4 md:px-6 max-w-5xl mx-auto w-full z-10 flex flex-col items-center">
        
        <!-- Header Section -->
        <div class="text-center mb-10">
            <div class="inline-block mb-4 px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-800 bg-gray-50/50 dark:bg-zinc-900/50 backdrop-blur-md text-[10px] font-bold uppercase tracking-widest text-blue-600">
                Powered by Mistral AI
            </div>
            <h2 class="text-3xl md:text-5xl font-black tracking-tighter mb-4">Dictée Intelligente</h2>
            <p class="text-gray-500 max-w-xl mx-auto text-sm md:text-base">
                Dictez votre texte. Laissez WikiMind le mettre en forme, corriger la ponctuation et le structurer instantanément.
            </p>
        </div>

        <!-- Editor Container -->
        <div class="w-full glass-panel rounded-3xl shadow-2xl overflow-hidden flex flex-col min-h-[50vh] relative transition-all duration-300 hover:shadow-[0_20px_40px_rgba(0,0,0,0.1)]">
            
            <!-- Toolbar -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-800 bg-gray-50/50 dark:bg-black/20">
                <div class="flex items-center gap-2">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span id="status-text" class="text-xs font-bold uppercase tracking-widest text-gray-500">En attente</span>
                </div>
                <button onclick="copyText()" class="text-xs font-bold uppercase tracking-widest hover:text-blue-500 transition">Copier</button>
            </div>

            <!-- Text Area -->
            <div id="editor-container" class="flex-grow p-6 md:p-10 outline-none overflow-y-auto text-lg md:text-xl leading-relaxed">
                <span id="final-span" class="text-gray-900 dark:text-gray-100 transition-colors"></span>
                <span id="interim-span" class="text-gray-400 italic"></span>
            </div>

            <!-- Action Bar (Floating) -->
            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-4 z-20">
                
                <!-- Mic Button -->
                <button id="mic-btn" onclick="toggleDictation()" class="w-16 h-16 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center shadow-lg hover:scale-105 transition-transform duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>

                <!-- AI Button -->
                <button id="ai-btn" onclick="processWithAI()" class="h-16 px-8 rounded-full bg-blue-600 text-white font-bold uppercase tracking-widest text-xs shadow-lg hover:bg-blue-700 hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <span id="ai-btn-text">Corriger & Formater</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </button>

            </div>
        </div>

    </main>

    <!-- SCRIPT -->
    <script>
        // CONFIGURATION
        const MISTRAL_API_KEY = "RmL56FeSccbbNpOC1KIDrYozHSFmY5eD"; // Ta clé
        
        // ELEMENTS DOM
        const micBtn = document.getElementById('mic-btn');
        const aiBtn = document.getElementById('ai-btn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const finalSpan = document.getElementById('final-span');
        const interimSpan = document.getElementById('interim-span');
        const editorContainer = document.getElementById('editor-container');

        // VARIABLES
        let recognition;
        let isRecording = false;
        let finalTranscript = "";

        // INITIALISATION SPEECH API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true; // IMPORTANT: Pour voir le texte en direct
            recognition.lang = 'fr-FR';

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('mic-active');
                statusText.innerText = "Écoute en cours...";
                statusText.classList.add('text-red-500');
                statusDot.classList.replace('bg-gray-400', 'bg-red-500');
            };

            recognition.onend = () => {
                if(isRecording) {
                    recognition.start(); // Redémarrer si coupé inopinément sauf si stop manuel
                } else {
                    micBtn.classList.remove('mic-active');
                    statusText.innerText = "En pause";
                    statusText.classList.remove('text-red-500');
                    statusDot.classList.replace('bg-red-500', 'bg-gray-400');
                    interimSpan.innerText = ""; // Nettoyer le gris
                }
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                
                // Boucle sur les résultats
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + " ";
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // MISE A JOUR UI
                finalSpan.innerText = finalTranscript; // Texte validé (Noir)
                interimSpan.innerText = interimTranscript; // Texte en cours (Gris)
                
                // Auto-scroll en bas
                editorContainer.scrollTop = editorContainer.scrollHeight;
            };

            recognition.onerror = (event) => {
                console.error("Erreur vocale:", event.error);
                statusText.innerText = "Erreur Micro";
            };

        } else {
            alert("Votre navigateur ne supporte pas la reconnaissance vocale (Utilisez Chrome/Edge).");
            micBtn.style.display = 'none';
        }

        // FONCTIONS
        function toggleDictation() {
            if (isRecording) {
                isRecording = false;
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        async function processWithAI() {
            const textToProcess = finalSpan.innerText + interimSpan.innerText;
            
            if (!textToProcess.trim()) {
                alert("Dictez d'abord du texte !");
                return;
            }

            // UI Loading
            const originalBtnText = document.getElementById('ai-btn-text').innerText;
            document.getElementById('ai-btn-text').innerText = "Transformation...";
            aiBtn.disabled = true;
            finalSpan.classList.add('ai-loading');
            
            try {
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "mistral-small-latest",
                        messages: [
                            {
                                "role": "system",
                                "content": "Tu es un assistant expert en rédaction. Reçois ce texte issu d'une dictée vocale. Corrige la grammaire, la ponctuation, ajoute les majuscules et structure le texte en paragraphes si nécessaire pour le rendre professionnel et clair. Ne change pas le sens. Réponds UNIQUEMENT avec le texte corrigé."
                            },
                            {
                                "role": "user",
                                "content": textToProcess
                            }
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    const correctedText = data.choices[0].message.content;
                    
                    // Animation de remplacement
                    finalSpan.classList.remove('ai-loading');
                    finalSpan.style.opacity = '0';
                    
                    setTimeout(() => {
                        finalTranscript = correctedText; // Mettre à jour la variable mémoire
                        finalSpan.innerHTML = correctedText.replace(/\n/g, '<br>'); // Gérer les sauts de ligne
                        interimSpan.innerText = "";
                        finalSpan.style.opacity = '1';
                    }, 300);
                }

            } catch (error) {
                console.error("Erreur API Mistral:", error);
                alert("Erreur de connexion à l'IA.");
                finalSpan.classList.remove('ai-loading');
            } finally {
                aiBtn.disabled = false;
                document.getElementById('ai-btn-text').innerText = originalBtnText;
            }
        }

        function copyText() {
            const text = finalSpan.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[onclick="copyText()"]');
                const original = btn.innerText;
                btn.innerText = "Copié !";
                setTimeout(() => btn.innerText = original, 2000);
            });
        }

        // THEME LOGIC (COPIÉ DE L'ORIGINAL)
        function toggleTheme() {
            const body = document.body; 
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            updateThemeIcon(isDark);
        }
        
        function updateThemeIcon(isDark) {
            const path = document.querySelector('#theme-icon path');
            if(isDark) path.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
            else path.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
        }

        // Init Theme
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
            updateThemeIcon(true);
        }
    </script>
</body>
</html>
